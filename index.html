<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PokeTracker - Pokemon Card Expense Tracker</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FF1C1C'/%3E%3Crect x='2' y='47' width='96' height='6' fill='%23222'/%3E%3Ccircle cx='50' cy='50' r='48' fill='none' stroke='%23222' stroke-width='4'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%23fff' stroke='%23222' stroke-width='4'/%3E%3Ccircle cx='50' cy='50' r='7' fill='%23222'/%3E%3Cpath d='M2 50 A48 48 0 0 0 98 50' fill='%23fff'/%3E%3Crect x='2' y='47' width='96' height='6' fill='%23222'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%23fff' stroke='%23222' stroke-width='4'/%3E%3Ccircle cx='50' cy='50' r='7' fill='%23222'/%3E%3C/svg%3E">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%230d1117'/%3E%3Ccircle cx='90' cy='90' r='70' fill='%23FF1C1C'/%3E%3Crect x='20' y='87' width='140' height='6' fill='%23222'/%3E%3Ccircle cx='90' cy='90' r='70' fill='none' stroke='%23222' stroke-width='4'/%3E%3Cpath d='M20 90 A70 70 0 0 0 160 90' fill='%23fff'/%3E%3Crect x='20' y='87' width='140' height='6' fill='%23222'/%3E%3Ccircle cx='90' cy='90' r='20' fill='%23fff' stroke='%23222' stroke-width='4'/%3E%3Ccircle cx='90' cy='90' r='10' fill='%23FF1C1C'/%3E%3C/svg%3E">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PokeTracker">
<meta name="theme-color" content="#0d1117">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Exo+2:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-primary:#0d1117;
  --bg-secondary:#161b22;
  --bg-tertiary:#1c2333;
  --bg-hover:#21283b;
  --border-color:#30363d;
  --text-primary:#e6edf3;
  --text-secondary:#8b949e;
  --text-muted:#6e7681;
  --red:#FF1C1C;
  --red-dark:#cc1616;
  --yellow:#FFCB05;
  --yellow-dark:#d4a904;
  --blue:#3B4CCA;
  --blue-light:#5b6cda;
  --store-color:#3B82F6;
  --online-color:#8B5CF6;
  --market-color:#10B981;
  --danger:#f85149;
  --font-display:'Exo 2',sans-serif;
  --font-body:'DM Sans',sans-serif;
  --radius:10px;
  --radius-sm:6px;
  --shadow:0 2px 8px rgba(0,0,0,0.3);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.4);
  --transition:0.2s ease;
}
html{font-size:16px;scroll-behavior:smooth}
body{
  font-family:var(--font-body);
  background:var(--bg-primary);
  color:var(--text-primary);
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
body::after{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.03;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='none' stroke='%23fff' stroke-width='2'/%3E%3Cline x1='2' y1='40' x2='78' y2='40' stroke='%23fff' stroke-width='2'/%3E%3Ccircle cx='40' cy='40' r='10' fill='none' stroke='%23fff' stroke-width='2'/%3E%3C/svg%3E");
  background-size:80px 80px;
}

.container{max-width:1100px;margin:0 auto;padding:0 20px;position:relative;z-index:1}

/* Header */
.header{
  padding:20px 0;
  border-bottom:1px solid var(--border-color);
  position:sticky;top:0;z-index:100;
  background:rgba(13,17,23,0.92);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
}
.header-inner{
  display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;
}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo svg{width:36px;height:36px;flex-shrink:0}
.logo-text{font-family:var(--font-display);font-weight:800;font-size:1.5rem;color:var(--text-primary);letter-spacing:-0.02em}
.logo-text span{color:var(--red)}
.header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* Currency Toggle */
.currency-toggle{
  display:flex;align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:50px;padding:3px;gap:0;
}
.currency-toggle button{
  border:none;background:transparent;color:var(--text-secondary);
  font-family:var(--font-body);font-weight:600;font-size:0.85rem;
  padding:6px 14px;border-radius:50px;cursor:pointer;transition:var(--transition);
  min-width:44px;min-height:36px;
}
.currency-toggle button.active{
  background:var(--red);color:#fff;box-shadow:0 2px 8px rgba(255,28,28,0.3);
}
.currency-toggle button:hover:not(.active){color:var(--text-primary)}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  font-family:var(--font-body);font-weight:600;font-size:0.85rem;
  padding:8px 18px;border-radius:50px;border:none;cursor:pointer;
  transition:all var(--transition);min-height:44px;
  text-decoration:none;
}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--red);color:#fff;box-shadow:0 2px 8px rgba(255,28,28,0.25)}
.btn-primary:hover{background:var(--red-dark);box-shadow:0 4px 16px rgba(255,28,28,0.35)}
.btn-secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-secondary:hover{background:var(--bg-hover);border-color:var(--text-muted)}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}
.btn-danger:hover{background:rgba(248,81,73,0.1)}
.btn-icon{
  width:38px;height:38px;padding:0;border-radius:8px;display:inline-flex;
  align-items:center;justify-content:center;background:transparent;border:none;
  color:var(--text-secondary);cursor:pointer;transition:var(--transition);min-height:38px;
}
.btn-icon:hover{background:var(--bg-hover);color:var(--text-primary)}
.btn-icon.delete:hover{color:var(--danger);background:rgba(248,81,73,0.1)}

/* Rate Status */
.rate-status{
  display:flex;align-items:center;gap:12px;padding:12px 16px;
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);margin-bottom:16px;flex-wrap:wrap;font-size:0.82rem;
  color:var(--text-secondary);
}
.rate-status .rate-pill{
  display:inline-flex;align-items:center;gap:4px;
  background:var(--bg-tertiary);padding:4px 10px;border-radius:50px;
  font-weight:600;color:var(--text-primary);font-size:0.78rem;
}
.rate-status .rate-pill .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.rate-status .dot.live{background:#10B981}
.rate-status .dot.fallback{background:var(--yellow)}
.rate-status button{
  background:none;border:none;color:var(--blue-light);cursor:pointer;
  font-size:0.78rem;font-weight:600;text-decoration:underline;font-family:var(--font-body);
}
.rate-status button:hover{color:var(--text-primary)}

/* Dashboard Cards */
.dashboard{
  display:grid;grid-template-columns:repeat(4,1fr);gap:16px;
  padding:24px 0;
}
.card{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:20px;
  position:relative;overflow:hidden;
  animation:cardFadeIn 0.5s ease forwards;opacity:0;
  transition:border-color var(--transition),box-shadow var(--transition);
}
.card:hover{border-color:rgba(255,28,28,0.2);box-shadow:0 0 20px rgba(255,28,28,0.05)}
@keyframes cardFadeIn{to{opacity:1;transform:translateY(0)}}
.card:nth-child(1){animation-delay:0s;transform:translateY(10px)}
.card:nth-child(2){animation-delay:0.08s;transform:translateY(10px)}
.card:nth-child(3){animation-delay:0.16s;transform:translateY(10px)}
.card:nth-child(4){animation-delay:0.24s;transform:translateY(10px)}
.card-label{font-size:0.8rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;font-weight:600;margin-bottom:6px}
.card-value{font-family:var(--font-display);font-weight:700;font-size:1.7rem;color:var(--text-primary);line-height:1.2}
.card-sub{font-size:0.8rem;color:var(--text-muted);margin-top:4px}
.card-icon{
  position:absolute;top:16px;right:16px;width:36px;height:36px;
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;
}
.card-icon.red{background:rgba(255,28,28,0.12);color:var(--red)}
.card-icon.yellow{background:rgba(255,203,5,0.12);color:var(--yellow)}
.card-icon.blue{background:rgba(59,76,202,0.12);color:var(--blue-light)}
.card-icon.green{background:rgba(16,185,129,0.12);color:var(--market-color)}

/* Source breakdown mini chart */
.source-breakdown{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.source-bar-row{display:flex;align-items:center;gap:8px;font-size:0.78rem}
.source-bar-label{width:52px;color:var(--text-secondary);flex-shrink:0}
.source-bar-track{flex:1;height:8px;background:var(--bg-primary);border-radius:4px;overflow:hidden}
.source-bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
.source-bar-fill.store{background:var(--store-color)}
.source-bar-fill.online{background:var(--online-color)}
.source-bar-fill.market{background:var(--market-color)}
.source-bar-pct{width:36px;text-align:right;color:var(--text-muted);font-weight:600}

/* Chart Section */
.chart-section{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:24px;margin-bottom:24px;
}
.chart-section h2{font-family:var(--font-display);font-weight:700;font-size:1.1rem;margin-bottom:16px}
.chart-container{position:relative;height:280px;width:100%}

/* Filter Bar */
.filter-bar{
  display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;
}
.search-wrap{
  flex:1;min-width:200px;position:relative;
}
.search-wrap svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);width:16px;height:16px}
.search-wrap input{
  width:100%;background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:50px;padding:10px 14px 10px 36px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.9rem;transition:var(--transition);
  min-height:44px;
}
.search-wrap input:focus{outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(255,28,28,0.1)}
.search-wrap input::placeholder{color:var(--text-muted)}
.filter-pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{
  padding:7px 14px;border-radius:50px;font-size:0.8rem;font-weight:600;
  border:1px solid var(--border-color);background:var(--bg-secondary);
  color:var(--text-secondary);cursor:pointer;transition:var(--transition);
  min-height:36px;display:flex;align-items:center;
}
.pill:hover{border-color:var(--text-muted);color:var(--text-primary)}
.pill.active{border-color:var(--red);color:var(--red);background:rgba(255,28,28,0.08)}
.pill.active[data-source="store"]{border-color:var(--store-color);color:var(--store-color);background:rgba(59,130,246,0.08)}
.pill.active[data-source="online"]{border-color:var(--online-color);color:var(--online-color);background:rgba(139,92,246,0.08)}
.pill.active[data-source="market"]{border-color:var(--market-color);color:var(--market-color);background:rgba(16,185,129,0.08)}

/* Date Range Filter */
.date-filter{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}
.date-filter label{font-size:0.8rem;color:var(--text-secondary);font-weight:600}
.date-filter input[type="date"]{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:7px 10px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.82rem;min-height:36px;transition:var(--transition);
}
.date-filter input[type="date"]:focus{outline:none;border-color:var(--red)}
.date-filter .btn-clear{
  background:none;border:none;color:var(--text-muted);cursor:pointer;
  font-size:0.78rem;font-weight:600;font-family:var(--font-body);padding:4px 8px;
  border-radius:var(--radius-sm);transition:var(--transition);
}
.date-filter .btn-clear:hover{color:var(--red);background:rgba(255,28,28,0.08)}

/* Table */
.table-wrap{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);overflow:hidden;margin-bottom:24px;
}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:700px}
thead{background:var(--bg-tertiary)}
thead th{
  padding:12px 16px;font-size:0.75rem;font-weight:600;
  text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);
  text-align:left;border-bottom:1px solid var(--border-color);white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border-color);transition:background var(--transition)}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--bg-hover)}
tbody td{padding:12px 16px;font-size:0.9rem;white-space:nowrap}
td.item-cell{white-space:normal;min-width:160px;max-width:240px}
.qty-badge{
  display:inline-flex;align-items:center;justify-content:center;
  background:var(--bg-tertiary);color:var(--text-secondary);
  font-size:0.75rem;font-weight:600;min-width:24px;height:22px;
  padding:0 6px;border-radius:4px;
}
.source-badge{
  display:inline-flex;align-items:center;padding:4px 10px;border-radius:50px;
  font-size:0.75rem;font-weight:600;text-transform:capitalize;
}
.source-badge.store{background:rgba(59,130,246,0.12);color:var(--store-color)}
.source-badge.online{background:rgba(139,92,246,0.12);color:var(--online-color)}
.source-badge.market{background:rgba(16,185,129,0.12);color:var(--market-color)}
.actions-cell{display:flex;gap:4px}

/* Pagination */
.pagination{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:12px 16px;border-top:1px solid var(--border-color);
}
.pagination button{
  min-width:36px;height:36px;border-radius:var(--radius-sm);
  border:1px solid var(--border-color);background:var(--bg-secondary);
  color:var(--text-secondary);font-size:0.85rem;cursor:pointer;transition:var(--transition);
  display:flex;align-items:center;justify-content:center;
}
.pagination button:hover:not(:disabled){background:var(--bg-hover);color:var(--text-primary)}
.pagination button.active{background:var(--red);color:#fff;border-color:var(--red)}
.pagination button:disabled{opacity:0.4;cursor:not-allowed}

/* Empty State */
.empty-state{text-align:center;padding:60px 20px}
.empty-state svg{width:64px;height:64px;color:var(--text-muted);margin-bottom:16px}
.empty-state h3{font-family:var(--font-display);font-weight:700;font-size:1.1rem;margin-bottom:8px}
.empty-state p{color:var(--text-secondary);margin-bottom:20px;font-size:0.9rem}

/* Footer */
.footer{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:24px 0 40px;flex-wrap:wrap;
}

/* Modal Overlay */
.modal-overlay{
  position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:opacity 0.25s ease,visibility 0.25s ease;
  padding:20px;
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:14px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;
  transform:translateY(20px) scale(0.97);transition:transform 0.25s ease;
  box-shadow:var(--shadow-lg);
}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px;border-bottom:1px solid var(--border-color);
}
.modal-header h2{font-family:var(--font-display);font-weight:700;font-size:1.15rem}
.modal-body{padding:24px}
.modal-footer{
  display:flex;gap:10px;justify-content:flex-end;
  padding:16px 24px;border-top:1px solid var(--border-color);
}

/* Form */
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:0.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em}
.form-group input,.form-group select,.form-group textarea{
  width:100%;background:var(--bg-primary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:10px 12px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.9rem;transition:var(--transition);
  min-height:44px;
}
.form-group textarea{min-height:80px;resize:vertical}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(255,28,28,0.1);
}
.form-group select{cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;
}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.store-name-wrap{display:flex;gap:8px}
.store-name-wrap select{flex:1}
.store-name-wrap .btn-add-store{
  flex-shrink:0;width:44px;height:44px;border-radius:var(--radius-sm);
  background:var(--bg-tertiary);border:1px solid var(--border-color);
  color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;
  justify-content:center;transition:var(--transition);font-size:1.2rem;
}
.store-name-wrap .btn-add-store:hover{color:var(--text-primary);border-color:var(--text-muted)}
.store-tag{
  display:inline-flex;align-items:center;gap:2px;
  font-size:0.72rem;color:var(--text-muted);max-width:100px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.price-input-wrap{position:relative}
.price-input-wrap .currency-label{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  color:var(--text-muted);font-weight:600;font-size:0.9rem;pointer-events:none;
}
.price-input-wrap input{padding-left:28px}
.auto-calc{font-size:0.75rem;color:var(--text-muted);margin-top:4px;font-style:italic}

/* Confirm Dialog */
.confirm-overlay{
  position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:opacity 0.2s ease,visibility 0.2s ease;
  padding:20px;
}
.confirm-overlay.open{opacity:1;visibility:visible}
.confirm-dialog{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:14px;padding:28px;max-width:380px;width:100%;text-align:center;
  transform:scale(0.95);transition:transform 0.2s ease;box-shadow:var(--shadow-lg);
}
.confirm-overlay.open .confirm-dialog{transform:scale(1)}
.confirm-dialog h3{font-family:var(--font-display);margin-bottom:8px;font-size:1.1rem}
.confirm-dialog p{color:var(--text-secondary);font-size:0.9rem;margin-bottom:20px}
.confirm-dialog .btn-row{display:flex;gap:10px;justify-content:center}

/* Loader */
.loader{display:flex;align-items:center;justify-content:center;padding:60px}
.pokeball-spinner{width:48px;height:48px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:400;
  background:var(--bg-tertiary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:12px 20px;
  font-size:0.85rem;color:var(--text-primary);
  box-shadow:var(--shadow-lg);
  transform:translateY(100px);opacity:0;transition:all 0.3s ease;
  pointer-events:none;max-width:340px;
}
.toast.show{transform:translateY(0);opacity:1}

/* Responsive */
@media(max-width:900px){
  .dashboard{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:640px){
  .header-inner{gap:10px}
  .logo-text{font-size:1.2rem}
  .dashboard{grid-template-columns:1fr 1fr;gap:10px}
  .card{padding:16px}
  .card-value{font-size:1.3rem}
  .chart-container{height:220px}
  .form-row,.form-row-3{grid-template-columns:1fr}
  .filter-bar{flex-direction:column;align-items:stretch}
  .search-wrap{min-width:unset}
  .date-filter{width:100%}
  .modal{max-width:100%;border-radius:14px 14px 0 0;max-height:95vh;align-self:flex-end}
  .modal-overlay{padding:0;align-items:flex-end}
  table{min-width:520px}
  .footer{flex-direction:column}
}
@media(max-width:400px){
  .dashboard{grid-template-columns:1fr}
  .header-actions{width:100%;justify-content:space-between}
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="container header-inner">
    <div class="logo">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="50" cy="50" r="48" stroke="#FF1C1C" stroke-width="4"/>
        <rect x="2" y="48" width="96" height="4" fill="#FF1C1C"/>
        <circle cx="50" cy="50" r="16" fill="#0d1117" stroke="#FF1C1C" stroke-width="4"/>
        <circle cx="50" cy="50" r="8" fill="#FF1C1C"/>
        <path d="M2 50 A48 48 0 0 1 98 50" fill="#FF1C1C" opacity="0.15"/>
      </svg>
      <div class="logo-text">Poke<span>Tracker</span></div>
    </div>
    <div class="header-actions">
      <div class="currency-toggle" role="radiogroup" aria-label="Currency selection">
        <button type="button" id="btn-gbp" class="active" role="radio" aria-checked="true" onclick="setCurrency('gbp')">£ GBP</button>
        <button type="button" id="btn-eur" role="radio" aria-checked="false" onclick="setCurrency('eur')">€ EUR</button>
        <button type="button" id="btn-usd" role="radio" aria-checked="false" onclick="setCurrency('usd')">$ USD</button>
      </div>
      <button type="button" class="btn btn-primary" onclick="openAddModal()" aria-label="Add purchase">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Purchase
      </button>
    </div>
  </div>
</header>

<main class="container">

  <!-- Rate Status Bar -->
  <div class="rate-status" id="rate-status" style="margin-top:16px">
    <span>Exchange Rates:</span>
    <span class="rate-pill" id="rate-gbp-eur"><span class="dot live"></span> 1 GBP = ... EUR</span>
    <span class="rate-pill" id="rate-gbp-usd"><span class="dot live"></span> 1 GBP = ... USD</span>
    <button type="button" onclick="fetchRates()" id="rate-refresh-btn">Refresh</button>
    <span id="rate-timestamp" style="margin-left:auto;font-size:0.75rem;color:var(--text-muted)"></span>
  </div>

  <!-- Dashboard Cards -->
  <section class="dashboard" aria-label="Spending summary">
    <div class="card">
      <div class="card-icon red" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      </div>
      <div class="card-label">Total Spent</div>
      <div class="card-value" id="total-spent">--</div>
      <div class="card-sub" id="total-spent-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon yellow" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="card-label">This Month</div>
      <div class="card-value" id="month-spent">--</div>
      <div class="card-sub" id="month-spent-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon blue" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 110-4h12V0"/><path d="M20 12v4H6a2 2 0 100 4h12v4"/></svg>
      </div>
      <div class="card-label">Total Items</div>
      <div class="card-value" id="purchase-count">--</div>
      <div class="card-sub" id="purchase-count-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon green" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div class="card-label">Source Breakdown</div>
      <div class="source-breakdown" id="source-breakdown"></div>
    </div>
  </section>

  <!-- Monthly Spending Chart -->
  <section class="chart-section">
    <h2>Monthly Spending</h2>
    <div class="chart-container">
      <canvas id="monthly-chart" aria-label="Monthly spending bar chart"></canvas>
    </div>
  </section>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search-input" placeholder="Search by item name..." aria-label="Search purchases" oninput="applyFilters()">
    </div>
    <div class="filter-pills" role="group" aria-label="Filter by source">
      <button type="button" class="pill active" data-source="all" onclick="setSourceFilter('all',this)">All</button>
      <button type="button" class="pill" data-source="store" onclick="setSourceFilter('store',this)">Store</button>
      <button type="button" class="pill" data-source="online" onclick="setSourceFilter('online',this)">Online</button>
      <button type="button" class="pill" data-source="market" onclick="setSourceFilter('market',this)">Market</button>
    </div>
  </div>

  <!-- Date Range Filter -->
  <div class="date-filter">
    <label for="date-from">From</label>
    <input type="date" id="date-from" onchange="applyFilters()">
    <label for="date-to">To</label>
    <input type="date" id="date-to" onchange="applyFilters()">
    <button type="button" class="btn-clear" onclick="clearDateFilter()">Clear dates</button>
  </div>

  <!-- Table -->
  <div class="table-wrap" style="margin-top:16px">
    <div class="table-scroll">
      <table id="purchases-table" aria-label="Purchases list">
        <thead>
          <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Total</th>
            <th>Source</th>
            <th>Store</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div id="empty-state" class="empty-state" style="display:none">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="2" opacity="0.3"/>
        <rect x="2" y="48" width="96" height="4" fill="currentColor" opacity="0.3"/>
        <circle cx="50" cy="50" r="12" stroke="currentColor" stroke-width="2" opacity="0.3"/>
      </svg>
      <h3>No purchases yet</h3>
      <p>Add your first Pokemon card purchase to get started!</p>
      <button type="button" class="btn btn-primary" onclick="openAddModal()">Add Purchase</button>
    </div>
    <div id="no-results" class="empty-state" style="display:none">
      <h3>No matching purchases</h3>
      <p>Try adjusting your search, filters, or date range.</p>
    </div>
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" style="display:none">
    <svg class="pokeball-spinner" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Loading">
      <circle cx="50" cy="50" r="48" stroke="#FF1C1C" stroke-width="4"/>
      <rect x="2" y="48" width="96" height="4" fill="#FF1C1C"/>
      <circle cx="50" cy="50" r="12" fill="#0d1117" stroke="#FF1C1C" stroke-width="4"/>
      <circle cx="50" cy="50" r="6" fill="#FF1C1C"/>
      <path d="M2 50 A48 48 0 0 1 98 50" fill="#FF1C1C" opacity="0.2"/>
    </svg>
  </div>
</main>

<!-- Footer -->
<footer class="footer container">
  <button type="button" class="btn btn-secondary" onclick="exportJSON()" aria-label="Export JSON data">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Export JSON
  </button>
  <label class="btn btn-secondary" tabindex="0" role="button" style="cursor:pointer" onkeydown="if(event.key==='Enter')this.querySelector('input').click()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    Import JSON
    <input type="file" accept=".json,application/json" style="display:none" onchange="importJSON(event)" aria-label="Import JSON file">
  </label>
</footer>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Add Purchase</h2>
      <button type="button" class="btn-icon" onclick="closeModal()" aria-label="Close modal">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="purchase-form" onsubmit="savePurchase(event)">
        <input type="hidden" id="form-id" value="">
        <div class="form-group">
          <label for="form-date">Date</label>
          <input type="date" id="form-date" required>
        </div>
        <div class="form-group">
          <label for="form-item">Item Name</label>
          <input type="text" id="form-item" placeholder="e.g. Charizard VMAX Alt Art" required>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label for="form-currency">Currency</label>
            <select id="form-currency" onchange="recalcPrice()">
              <option value="gbp">£ GBP</option>
              <option value="eur">€ EUR</option>
              <option value="usd">$ USD</option>
            </select>
          </div>
          <div class="form-group">
            <label for="form-price">Unit Price</label>
            <div class="price-input-wrap">
              <span class="currency-label" id="form-currency-symbol">&pound;</span>
              <input type="number" id="form-price" step="0.01" min="0" placeholder="0.00" required oninput="recalcPrice()">
            </div>
          </div>
          <div class="form-group">
            <label for="form-quantity">Quantity</label>
            <input type="number" id="form-quantity" min="1" step="1" value="1" required oninput="recalcPrice()">
          </div>
        </div>
        <div class="auto-calc" id="form-auto-calc" style="margin-top:-10px;margin-bottom:16px"></div>
        <div class="form-row">
          <div class="form-group">
            <label for="form-source">Source Type</label>
            <select id="form-source" required>
              <option value="store">Store</option>
              <option value="online">Online</option>
              <option value="market">Market</option>
            </select>
          </div>
          <div class="form-group">
            <label for="form-store-name">Store Name</label>
            <div class="store-name-wrap">
              <select id="form-store-name">
                <option value="">-- Select store --</option>
              </select>
              <button type="button" class="btn-add-store" onclick="addNewStore()" aria-label="Add new store" title="Add new store">+</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="form-notes">Notes (optional)</label>
          <textarea id="form-notes" placeholder="Any notes about this purchase..." rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button type="submit" class="btn btn-primary" form="purchase-form" id="form-submit-btn">Add Purchase</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirm-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-desc">
  <div class="confirm-dialog">
    <h3 id="confirm-title">Delete Purchase?</h3>
    <p id="confirm-desc">This action cannot be undone.</p>
    <div class="btn-row">
      <button type="button" class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== State ===== */
let purchases = [];
let currency = 'gbp'; // 'gbp' | 'eur' | 'usd'
let searchQuery = '';
let sourceFilter = 'all';
let dateFrom = '';
let dateTo = '';
let currentPage = 1;
const PAGE_SIZE = 20;
let editingId = null;
let monthlyChart = null;

// Exchange rates: everything relative to GBP as base
// Fallback rates used if API fails
let rates = { gbp: 1, eur: 1.17, usd: 1.26 };
let ratesLive = false;

// Store names list (persisted in localStorage)
let storeNames = [];

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  showLoader(true);
  loadStoreNames();
  // Fetch rates and data in parallel
  const [ratesResult] = await Promise.allSettled([fetchRates(), loadData()]);
  // Collect any store names from existing purchases
  syncStoreNamesFromPurchases();
  showLoader(false);
  renderAll();
}

async function loadData() {
  // Try localStorage first (persists user edits across refreshes)
  const saved = localStorage.getItem('poketracker_purchases');
  if (saved) {
    try {
      purchases = JSON.parse(saved);
      if (!Array.isArray(purchases)) purchases = [];
      migratePurchases();
      return;
    } catch (e) {
      console.warn('Invalid localStorage data, falling back to data.json');
    }
  }
  // Fall back to data.json (initial seed data)
  try {
    const res = await fetch('./data.json');
    if (!res.ok) throw new Error('Failed to load data');
    purchases = await res.json();
    if (!Array.isArray(purchases)) purchases = [];
    migratePurchases();
    saveToStorage();
  } catch (e) {
    console.warn('Could not load data.json:', e);
    purchases = [];
  }
}

function migratePurchases() {
  purchases.forEach(p => {
    if (!p.quantity) p.quantity = 1;
    if (p.price_usd === undefined) p.price_usd = parseFloat((p.price_gbp * rates.usd).toFixed(2));
  });
}

function saveToStorage() {
  try {
    localStorage.setItem('poketracker_purchases', JSON.stringify(purchases));
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}

/* ===== Store Names ===== */
function loadStoreNames() {
  try {
    const saved = localStorage.getItem('poketracker_stores');
    if (saved) storeNames = JSON.parse(saved);
    if (!Array.isArray(storeNames)) storeNames = [];
  } catch (e) { storeNames = []; }
}

function saveStoreNames() {
  try {
    localStorage.setItem('poketracker_stores', JSON.stringify(storeNames));
  } catch (e) {}
}

function syncStoreNamesFromPurchases() {
  purchases.forEach(p => {
    if (p.store_name && !storeNames.includes(p.store_name)) {
      storeNames.push(p.store_name);
    }
  });
  storeNames.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
  saveStoreNames();
}

function populateStoreDropdown(selectedValue) {
  const sel = document.getElementById('form-store-name');
  sel.innerHTML = '<option value="">-- Select store --</option>';
  storeNames.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  if (selectedValue) sel.value = selectedValue;
}

function addNewStore() {
  const name = prompt('Enter new store name:');
  if (!name || !name.trim()) return;
  const trimmed = name.trim();
  if (!storeNames.includes(trimmed)) {
    storeNames.push(trimmed);
    storeNames.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    saveStoreNames();
  }
  populateStoreDropdown(trimmed);
}

async function fetchRates() {
  try {
    const res = await fetch('https://open.er-api.com/v6/latest/GBP');
    if (!res.ok) throw new Error('Rate API error');
    const data = await res.json();
    if (data && data.rates) {
      rates.eur = data.rates.EUR || rates.eur;
      rates.usd = data.rates.USD || rates.usd;
      ratesLive = true;
      updateRateDisplay();
      showToast('Live exchange rates loaded');
      return;
    }
  } catch (e) {
    console.warn('Rate API failed, using fallback rates:', e);
  }
  ratesLive = false;
  updateRateDisplay();
}

function updateRateDisplay() {
  const dotClass = ratesLive ? 'live' : 'fallback';
  const label = ratesLive ? 'Live' : 'Fallback';
  document.getElementById('rate-gbp-eur').innerHTML = `<span class="dot ${dotClass}"></span> 1 GBP = ${rates.eur.toFixed(4)} EUR`;
  document.getElementById('rate-gbp-usd').innerHTML = `<span class="dot ${dotClass}"></span> 1 GBP = ${rates.usd.toFixed(4)} USD`;
  document.getElementById('rate-timestamp').textContent = ratesLive ? 'Live rates' : 'Fallback rates';
}

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'flex' : 'none';
}

/* ===== Currency ===== */
function setCurrency(c) {
  currency = c;
  ['gbp', 'eur', 'usd'].forEach(cur => {
    const btn = document.getElementById('btn-' + cur);
    btn.classList.toggle('active', c === cur);
    btn.setAttribute('aria-checked', c === cur);
  });
  renderAll();
}

function convertToDisplay(priceGbp) {
  if (currency === 'gbp') return priceGbp;
  if (currency === 'eur') return priceGbp * rates.eur;
  return priceGbp * rates.usd;
}

function formatPrice(priceGbp) {
  const val = convertToDisplay(priceGbp);
  return currencySymbol() + val.toFixed(2);
}

function getDisplayPrice(entry) {
  return convertToDisplay(entry.price_gbp);
}

function currencySymbol() {
  if (currency === 'gbp') return '\u00A3';
  if (currency === 'eur') return '\u20AC';
  return '$';
}

/* ===== Render All ===== */
function renderAll() {
  renderDashboard();
  renderChart();
  renderTable();
}

/* ===== Dashboard ===== */
function renderDashboard() {
  const total = purchases.reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1), 0);
  const now = new Date();
  const thisMonth = purchases.filter(e => {
    const d = new Date(e.date);
    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
  });
  const monthTotal = thisMonth.reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1), 0);
  const totalItems = purchases.reduce((s, e) => s + (e.quantity || 1), 0);

  document.getElementById('total-spent').textContent = currencySymbol() + total.toFixed(2);
  document.getElementById('total-spent-sub').textContent = purchases.length + ' purchase' + (purchases.length !== 1 ? 's' : '') + ' total';
  document.getElementById('month-spent').textContent = currencySymbol() + monthTotal.toFixed(2);
  document.getElementById('month-spent-sub').textContent = thisMonth.length + ' purchase' + (thisMonth.length !== 1 ? 's' : '') + ' this month';
  document.getElementById('purchase-count').textContent = totalItems;
  document.getElementById('purchase-count-sub').textContent = purchases.length + ' line item' + (purchases.length !== 1 ? 's' : '');

  // Source breakdown by spend
  const spendBySource = { store: 0, online: 0, market: 0 };
  purchases.forEach(e => {
    if (spendBySource[e.source] !== undefined) {
      spendBySource[e.source] += getDisplayPrice(e) * (e.quantity || 1);
    }
  });
  const totalSpend = total || 1;
  const breakdown = document.getElementById('source-breakdown');
  breakdown.innerHTML = ['store', 'online', 'market'].map(src => {
    const pct = Math.round((spendBySource[src] / totalSpend) * 100);
    return `<div class="source-bar-row">
      <span class="source-bar-label">${src.charAt(0).toUpperCase() + src.slice(1)}</span>
      <div class="source-bar-track"><div class="source-bar-fill ${src}" style="width:${pct}%"></div></div>
      <span class="source-bar-pct">${pct}%</span>
    </div>`;
  }).join('');
}

/* ===== Chart ===== */
function renderChart() {
  const canvas = document.getElementById('monthly-chart');
  const ctx = canvas.getContext('2d');

  const now = new Date();
  const months = [];
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push({ year: d.getFullYear(), month: d.getMonth(), label: d.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }) });
  }

  const data = months.map(m => {
    return purchases.filter(e => {
      const d = new Date(e.date);
      return d.getFullYear() === m.year && d.getMonth() === m.month;
    }).reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1), 0);
  });

  if (monthlyChart) monthlyChart.destroy();

  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(255, 28, 28, 0.8)');
  gradient.addColorStop(1, 'rgba(255, 28, 28, 0.15)');

  monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months.map(m => m.label),
      datasets: [{
        label: 'Spending',
        data: data,
        backgroundColor: gradient,
        borderColor: 'rgba(255, 28, 28, 0.9)',
        borderWidth: 1,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600, easing: 'easeOutQuart' },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#161b22',
          titleColor: '#e6edf3',
          bodyColor: '#e6edf3',
          borderColor: '#30363d',
          borderWidth: 1,
          cornerRadius: 8,
          padding: 12,
          callbacks: {
            label: function(c) { return currencySymbol() + c.parsed.y.toFixed(2); }
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false },
          ticks: { color: '#8b949e', font: { family: 'DM Sans', size: 11 } }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(48, 54, 61, 0.5)', drawBorder: false },
          ticks: {
            color: '#8b949e',
            font: { family: 'DM Sans', size: 11 },
            callback: function(val) { return currencySymbol() + val; }
          }
        }
      }
    }
  });
}

/* ===== Table ===== */
function getFiltered() {
  let list = [...purchases];
  if (sourceFilter !== 'all') list = list.filter(e => e.source === sourceFilter);
  if (searchQuery.trim()) {
    const q = searchQuery.toLowerCase().trim();
    list = list.filter(e => e.item.toLowerCase().includes(q));
  }
  if (dateFrom) list = list.filter(e => e.date >= dateFrom);
  if (dateTo) list = list.filter(e => e.date <= dateTo);
  list.sort((a, b) => (b.date > a.date ? 1 : b.date < a.date ? -1 : 0));
  return list;
}

function renderTable() {
  const filtered = getFiltered();
  const tbody = document.getElementById('table-body');
  const emptyState = document.getElementById('empty-state');
  const noResults = document.getElementById('no-results');
  const tableEl = document.getElementById('purchases-table');
  const paginationEl = document.getElementById('pagination');

  if (purchases.length === 0) {
    tableEl.style.display = 'none';
    paginationEl.style.display = 'none';
    noResults.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';

  if (filtered.length === 0) {
    tableEl.style.display = 'none';
    paginationEl.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }
  noResults.style.display = 'none';
  tableEl.style.display = 'table';

  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = filtered.slice(start, start + PAGE_SIZE);

  tbody.innerHTML = pageItems.map(entry => {
    const dateFormatted = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    const qty = entry.quantity || 1;
    const unitPrice = getDisplayPrice(entry);
    const lineTotal = unitPrice * qty;
    return `<tr>
      <td>${dateFormatted}</td>
      <td class="item-cell">${escapeHtml(entry.item)}</td>
      <td><span class="qty-badge">${qty}</span></td>
      <td>${currencySymbol()}${unitPrice.toFixed(2)}</td>
      <td><strong>${currencySymbol()}${lineTotal.toFixed(2)}</strong></td>
      <td><span class="source-badge ${entry.source}">${entry.source}</span></td>
      <td>${entry.store_name ? `<span class="store-tag" title="${escapeHtml(entry.store_name)}">${escapeHtml(entry.store_name)}</span>` : '<span class="store-tag">-</span>'}</td>
      <td>
        <div class="actions-cell">
          <button type="button" class="btn-icon" onclick="openEditModal('${entry.id}')" aria-label="Edit ${escapeHtml(entry.item)}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button type="button" class="btn-icon delete" onclick="confirmDelete('${entry.id}')" aria-label="Delete ${escapeHtml(entry.item)}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
          </button>
        </div>
      </td>
    </tr>`;
  }).join('');

  if (totalPages <= 1) {
    paginationEl.style.display = 'none';
  } else {
    paginationEl.style.display = 'flex';
    let html = `<button type="button" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})" aria-label="Previous page">&laquo;</button>`;
    for (let i = 1; i <= totalPages; i++) {
      if (totalPages > 7 && i > 2 && i < totalPages - 1 && Math.abs(i - currentPage) > 1) {
        if (i === 3 || i === totalPages - 2) html += `<button type="button" disabled>...</button>`;
        continue;
      }
      html += `<button type="button" class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    html += `<button type="button" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})" aria-label="Next page">&raquo;</button>`;
    paginationEl.innerHTML = html;
  }
}

function goToPage(page) {
  currentPage = page;
  renderTable();
  document.querySelector('.table-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* ===== Filters ===== */
function applyFilters() {
  searchQuery = document.getElementById('search-input').value;
  dateFrom = document.getElementById('date-from').value;
  dateTo = document.getElementById('date-to').value;
  currentPage = 1;
  renderTable();
}

function clearDateFilter() {
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  dateFrom = '';
  dateTo = '';
  currentPage = 1;
  renderTable();
}

function setSourceFilter(source, el) {
  sourceFilter = source;
  document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  currentPage = 1;
  renderTable();
}

/* ===== Modal ===== */
function openAddModal() {
  editingId = null;
  document.getElementById('modal-title').textContent = 'Add Purchase';
  document.getElementById('form-submit-btn').textContent = 'Add Purchase';
  document.getElementById('form-id').value = '';
  document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('form-item').value = '';
  document.getElementById('form-price').value = '';
  document.getElementById('form-quantity').value = '1';
  document.getElementById('form-currency').value = 'gbp';
  document.getElementById('form-source').value = 'store';
  document.getElementById('form-notes').value = '';
  document.getElementById('form-auto-calc').textContent = '';
  document.getElementById('form-currency-symbol').innerHTML = '&pound;';
  populateStoreDropdown('');
  openModal();
}

function openEditModal(id) {
  const entry = purchases.find(e => e.id === id);
  if (!entry) return;
  editingId = id;
  document.getElementById('modal-title').textContent = 'Edit Purchase';
  document.getElementById('form-submit-btn').textContent = 'Save Changes';
  document.getElementById('form-id').value = entry.id;
  document.getElementById('form-date').value = entry.date;
  document.getElementById('form-item').value = entry.item;
  document.getElementById('form-currency').value = 'gbp';
  document.getElementById('form-price').value = entry.price_gbp.toFixed(2);
  document.getElementById('form-quantity').value = entry.quantity || 1;
  document.getElementById('form-source').value = entry.source;
  document.getElementById('form-notes').value = entry.notes || '';
  document.getElementById('form-currency-symbol').innerHTML = '&pound;';
  populateStoreDropdown(entry.store_name || '');
  recalcPrice();
  openModal();
}

function openModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('form-date').focus(), 300);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('confirm-overlay').classList.contains('open')) {
      closeConfirm();
    } else if (document.getElementById('modal-overlay').classList.contains('open')) {
      closeModal();
    }
  }
});

function recalcPrice() {
  const cur = document.getElementById('form-currency').value;
  const priceVal = parseFloat(document.getElementById('form-price').value);
  const qty = parseInt(document.getElementById('form-quantity').value) || 1;
  const symbols = { gbp: '&pound;', eur: '&euro;', usd: '$' };
  document.getElementById('form-currency-symbol').innerHTML = symbols[cur];

  if (isNaN(priceVal) || priceVal <= 0) {
    document.getElementById('form-auto-calc').textContent = '';
    return;
  }

  // Convert input to GBP first
  let gbp;
  if (cur === 'gbp') gbp = priceVal;
  else if (cur === 'eur') gbp = priceVal / rates.eur;
  else gbp = priceVal / rates.usd;

  const eur = gbp * rates.eur;
  const usd = gbp * rates.usd;
  const lineTotal = priceVal * qty;

  let parts = [];
  if (cur !== 'gbp') parts.push('\u00A3' + gbp.toFixed(2));
  if (cur !== 'eur') parts.push('\u20AC' + eur.toFixed(2));
  if (cur !== 'usd') parts.push('$' + usd.toFixed(2));

  let text = '= ' + parts.join(' / ');
  if (qty > 1) text += ` | Line total: ${symbols[cur].replace(/&[a-z]+;/g, match => ({'&pound;':'\u00A3','&euro;':'\u20AC'}[match]||match))}${lineTotal.toFixed(2)}`;
  if (qty > 1) {
    const sym = cur === 'gbp' ? '\u00A3' : cur === 'eur' ? '\u20AC' : '$';
    text = '= ' + parts.join(' / ') + ' | Line total: ' + sym + lineTotal.toFixed(2);
  }
  document.getElementById('form-auto-calc').textContent = text;
}

/* ===== Save ===== */
function savePurchase(e) {
  e.preventDefault();
  const cur = document.getElementById('form-currency').value;
  const price = parseFloat(document.getElementById('form-price').value);
  const qty = parseInt(document.getElementById('form-quantity').value) || 1;
  if (isNaN(price) || price < 0) return;

  // Convert to GBP as base
  let gbp;
  if (cur === 'gbp') gbp = price;
  else if (cur === 'eur') gbp = price / rates.eur;
  else gbp = price / rates.usd;

  const entry = {
    id: editingId || crypto.randomUUID(),
    date: document.getElementById('form-date').value,
    item: document.getElementById('form-item').value.trim(),
    quantity: qty,
    price_gbp: parseFloat(gbp.toFixed(2)),
    price_eur: parseFloat((gbp * rates.eur).toFixed(2)),
    price_usd: parseFloat((gbp * rates.usd).toFixed(2)),
    source: document.getElementById('form-source').value,
    store_name: document.getElementById('form-store-name').value || '',
    notes: document.getElementById('form-notes').value.trim(),
  };

  if (editingId) {
    const idx = purchases.findIndex(e => e.id === editingId);
    if (idx !== -1) purchases[idx] = entry;
    showToast('Purchase updated');
  } else {
    purchases.push(entry);
    showToast('Purchase added');
  }

  saveToStorage();
  closeModal();
  currentPage = 1;
  renderAll();
}

/* ===== Delete ===== */
let deleteTargetId = null;

function confirmDelete(id) {
  deleteTargetId = id;
  const entry = purchases.find(e => e.id === id);
  document.getElementById('confirm-desc').textContent = entry
    ? `Delete "${entry.item}"? This action cannot be undone.`
    : 'This action cannot be undone.';
  document.getElementById('confirm-overlay').classList.add('open');
  document.getElementById('confirm-delete-btn').focus();
}

function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('open');
  deleteTargetId = null;
}

document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  if (deleteTargetId) {
    purchases = purchases.filter(e => e.id !== deleteTargetId);
    saveToStorage();
    showToast('Purchase deleted');
    closeConfirm();
    renderAll();
  }
});

document.getElementById('confirm-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

/* ===== Export / Import ===== */
function exportJSON() {
  const blob = new Blob([JSON.stringify(purchases, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('JSON exported');
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('Invalid format');
      // Migrate imported data
      data.forEach(p => {
        if (!p.quantity) p.quantity = 1;
        if (p.price_usd === undefined) p.price_usd = parseFloat((p.price_gbp * rates.usd).toFixed(2));
      });
      purchases = data;
      saveToStorage();
      currentPage = 1;
      renderAll();
      showToast('Imported ' + data.length + ' purchase' + (data.length !== 1 ? 's' : ''));
    } catch (err) {
      showToast('Error: Invalid JSON file');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===== Toast ===== */
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.classList.remove('show'), 2500);
}
</script>
</body>
</html>
