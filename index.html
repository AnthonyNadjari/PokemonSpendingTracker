<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PokeTracker - Pokemon Card Expense Tracker</title>
<link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PokeTracker">
<meta name="theme-color" content="#0d1117">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Exo+2:wght@600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg-primary:#0d1117;
  --bg-secondary:#161b22;
  --bg-tertiary:#1c2333;
  --bg-hover:#21283b;
  --border-color:#30363d;
  --text-primary:#e6edf3;
  --text-secondary:#8b949e;
  --text-muted:#6e7681;
  --red:#FF1C1C;
  --red-dark:#cc1616;
  --yellow:#FFCB05;
  --yellow-dark:#d4a904;
  --blue:#3B4CCA;
  --blue-light:#5b6cda;
  --store-color:#3B82F6;
  --online-color:#8B5CF6;
  --market-color:#10B981;
  --danger:#f85149;
  --font-display:'Exo 2',sans-serif;
  --font-body:'DM Sans',sans-serif;
  --radius:10px;
  --radius-sm:6px;
  --shadow:0 2px 8px rgba(0,0,0,0.3);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.4);
  --transition:0.2s ease;
}
html{font-size:16px;scroll-behavior:smooth}
body{
  font-family:var(--font-body);
  background:var(--bg-primary);
  color:var(--text-primary);
  line-height:1.6;
  min-height:100vh;
  overflow-x:hidden;
  transition:background 0.3s ease,color 0.3s ease;
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  transition:opacity 0.3s ease;
}
body::after{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.03;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Ccircle cx='40' cy='40' r='38' fill='none' stroke='%23fff' stroke-width='2'/%3E%3Cline x1='2' y1='40' x2='78' y2='40' stroke='%23fff' stroke-width='2'/%3E%3Ccircle cx='40' cy='40' r='10' fill='none' stroke='%23fff' stroke-width='2'/%3E%3C/svg%3E");
  background-size:80px 80px;
  transition:opacity 0.3s ease;
}

/* Light Mode */
body.light-mode{
  --bg-primary:#f5f6f8;
  --bg-secondary:#ffffff;
  --bg-tertiary:#f0f2f5;
  --bg-hover:#e8eaed;
  --border-color:#d0d7de;
  --text-primary:#1f2328;
  --text-secondary:#656d76;
  --text-muted:#8b949e;
  --shadow:0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.12);
}
body.light-mode::before{opacity:0}
body.light-mode::after{opacity:0}
body.light-mode .header{background:rgba(245,246,248,0.95)}
body.light-mode .logo svg rect[fill="#333"]{fill:#444}
body.light-mode .logo svg circle[stroke="#333"]{stroke:#444}
body.light-mode .card:hover{border-color:rgba(255,28,28,0.15);box-shadow:0 0 20px rgba(255,28,28,0.04)}
body.light-mode .chart-section{box-shadow:var(--shadow)}
body.light-mode .table-wrap{box-shadow:var(--shadow)}
body.light-mode .modal{box-shadow:var(--shadow-lg)}
body.light-mode .modal-overlay{background:rgba(0,0,0,0.3)}
body.light-mode .confirm-overlay{background:rgba(0,0,0,0.3)}
body.light-mode .toast{background:var(--bg-secondary);border-color:var(--border-color);box-shadow:var(--shadow-lg)}

/* Theme Toggle */
.theme-toggle{
  width:40px;height:40px;border-radius:50%;border:1px solid var(--border-color);
  background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all var(--transition);flex-shrink:0;
}
.theme-toggle:hover{color:var(--text-primary);border-color:var(--text-muted);background:var(--bg-hover)}
.theme-toggle svg{width:18px;height:18px;transition:transform 0.3s ease}
.theme-toggle:active svg{transform:rotate(30deg)}

.container{max-width:1100px;margin:0 auto;padding:0 20px;position:relative;z-index:1}

/* Header */
.header{
  padding:20px 0;
  border-bottom:1px solid var(--border-color);
  position:sticky;top:0;z-index:100;
  background:rgba(13,17,23,0.92);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
}
.header-inner{
  display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;
}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo svg{width:36px;height:36px;flex-shrink:0}
.logo-text{font-family:var(--font-display);font-weight:800;font-size:1.5rem;color:var(--text-primary);letter-spacing:-0.02em}
.logo-text span{color:var(--red)}
.header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

/* Currency Toggle */
.currency-toggle{
  display:flex;align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:50px;padding:3px;gap:0;
}
.currency-toggle button{
  border:none;background:transparent;color:var(--text-secondary);
  font-family:var(--font-body);font-weight:600;font-size:0.85rem;
  padding:6px 14px;border-radius:50px;cursor:pointer;transition:var(--transition);
  min-width:44px;min-height:36px;
}
.currency-toggle button.active{
  background:var(--red);color:#fff;box-shadow:0 2px 8px rgba(255,28,28,0.3);
}
.currency-toggle button:hover:not(.active){color:var(--text-primary)}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  font-family:var(--font-body);font-weight:600;font-size:0.85rem;
  padding:8px 18px;border-radius:50px;border:none;cursor:pointer;
  transition:all var(--transition);min-height:44px;
  text-decoration:none;
}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--red);color:#fff;box-shadow:0 2px 8px rgba(255,28,28,0.25)}
.btn-primary:hover{background:var(--red-dark);box-shadow:0 4px 16px rgba(255,28,28,0.35)}
.btn-secondary{background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-secondary:hover{background:var(--bg-hover);border-color:var(--text-muted)}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}
.btn-danger:hover{background:rgba(248,81,73,0.1)}
.btn-icon{
  width:38px;height:38px;padding:0;border-radius:8px;display:inline-flex;
  align-items:center;justify-content:center;background:transparent;border:none;
  color:var(--text-secondary);cursor:pointer;transition:var(--transition);min-height:38px;
}
.btn-icon:hover{background:var(--bg-hover);color:var(--text-primary)}
.btn-icon.delete:hover{color:var(--danger);background:rgba(248,81,73,0.1)}

/* Rate Status */
.rate-status{
  display:flex;align-items:center;gap:12px;padding:12px 16px;
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);margin-bottom:16px;flex-wrap:wrap;font-size:0.82rem;
  color:var(--text-secondary);
}
.rate-status .rate-pill{
  display:inline-flex;align-items:center;gap:4px;
  background:var(--bg-tertiary);padding:4px 10px;border-radius:50px;
  font-weight:600;color:var(--text-primary);font-size:0.78rem;
}
.rate-status .rate-pill .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.rate-status .dot.live{background:#10B981}
.rate-status .dot.fallback{background:var(--yellow)}
.rate-status button{
  background:none;border:none;color:var(--blue-light);cursor:pointer;
  font-size:0.78rem;font-weight:600;text-decoration:underline;font-family:var(--font-body);
}
.rate-status button:hover{color:var(--text-primary)}

/* Dashboard Cards */
.dashboard{
  display:grid;grid-template-columns:repeat(4,1fr);gap:16px;
  padding:24px 0;
}
.card{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:20px;
  position:relative;overflow:hidden;
  animation:cardFadeIn 0.5s ease forwards;opacity:0;
  transition:border-color var(--transition),box-shadow var(--transition);
}
.card:hover{border-color:rgba(255,28,28,0.2);box-shadow:0 0 20px rgba(255,28,28,0.05)}
@keyframes cardFadeIn{to{opacity:1;transform:translateY(0)}}
.card:nth-child(1){animation-delay:0s;transform:translateY(10px)}
.card:nth-child(2){animation-delay:0.08s;transform:translateY(10px)}
.card:nth-child(3){animation-delay:0.16s;transform:translateY(10px)}
.card:nth-child(4){animation-delay:0.24s;transform:translateY(10px)}
.card-label{font-size:0.8rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;font-weight:600;margin-bottom:6px}
.card-value{font-family:var(--font-display);font-weight:700;font-size:1.7rem;color:var(--text-primary);line-height:1.2}
.card-sub{font-size:0.8rem;color:var(--text-muted);margin-top:4px}
.card-icon{
  position:absolute;top:16px;right:16px;width:36px;height:36px;
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;
}
.card-icon.red{background:rgba(255,28,28,0.12);color:var(--red)}
.card-icon.yellow{background:rgba(255,203,5,0.12);color:var(--yellow)}
.card-icon.blue{background:rgba(59,76,202,0.12);color:var(--blue-light)}
.card-icon.green{background:rgba(16,185,129,0.12);color:var(--market-color)}

/* Source breakdown mini chart */
.source-breakdown{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.source-bar-row{display:flex;align-items:center;gap:8px;font-size:0.78rem}
.source-bar-label{width:52px;color:var(--text-secondary);flex-shrink:0}
.source-bar-track{flex:1;height:8px;background:var(--bg-primary);border-radius:4px;overflow:hidden}
.source-bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
.source-bar-fill.store{background:var(--store-color)}
.source-bar-fill.online{background:var(--online-color)}
.source-bar-fill.market{background:var(--market-color)}
.source-bar-pct{width:36px;text-align:right;color:var(--text-muted);font-weight:600}

/* Chart Section */
.chart-section{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:24px;margin-bottom:24px;
}
.chart-section h2{font-family:var(--font-display);font-weight:700;font-size:1.1rem;margin-bottom:16px}
.chart-container{position:relative;height:280px;width:100%}

/* Filter Bar */
.filter-bar{
  display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;
}
.search-wrap{
  flex:1;min-width:200px;position:relative;
}
.search-wrap svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);width:16px;height:16px}
.search-wrap input{
  width:100%;background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:50px;padding:10px 14px 10px 36px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.9rem;transition:var(--transition);
  min-height:44px;
}
.search-wrap input:focus{outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(255,28,28,0.1)}
.search-wrap input::placeholder{color:var(--text-muted)}
.filter-pills{display:flex;gap:6px;flex-wrap:wrap}
.pill{
  padding:7px 14px;border-radius:50px;font-size:0.8rem;font-weight:600;
  border:1px solid var(--border-color);background:var(--bg-secondary);
  color:var(--text-secondary);cursor:pointer;transition:var(--transition);
  min-height:36px;display:flex;align-items:center;
}
.pill:hover{border-color:var(--text-muted);color:var(--text-primary)}
.pill.active{border-color:var(--red);color:var(--red);background:rgba(255,28,28,0.08)}
.pill.active[data-source="store"]{border-color:var(--store-color);color:var(--store-color);background:rgba(59,130,246,0.08)}
.pill.active[data-source="online"]{border-color:var(--online-color);color:var(--online-color);background:rgba(139,92,246,0.08)}
.pill.active[data-source="market"]{border-color:var(--market-color);color:var(--market-color);background:rgba(16,185,129,0.08)}

/* Date Range Filter */
.date-filter{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}
.date-filter label{font-size:0.8rem;color:var(--text-secondary);font-weight:600}
.date-filter input[type="date"]{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:7px 10px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.82rem;min-height:36px;transition:var(--transition);
}
.date-filter input[type="date"]:focus{outline:none;border-color:var(--red)}
.date-filter .btn-clear{
  background:none;border:none;color:var(--text-muted);cursor:pointer;
  font-size:0.78rem;font-weight:600;font-family:var(--font-body);padding:4px 8px;
  border-radius:var(--radius-sm);transition:var(--transition);
}
.date-filter .btn-clear:hover{color:var(--red);background:rgba(255,28,28,0.08)}

/* Table */
.table-wrap{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);overflow:hidden;margin-bottom:24px;
}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:700px}
thead{background:var(--bg-tertiary)}
thead th{
  padding:12px 16px;font-size:0.75rem;font-weight:600;
  text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);
  text-align:left;border-bottom:1px solid var(--border-color);white-space:nowrap;
}
thead th.sortable{cursor:pointer;user-select:none;position:relative;padding-right:24px;transition:color var(--transition)}
thead th.sortable:hover{color:var(--text-primary)}
thead th.sortable::after{
  content:'';position:absolute;right:8px;top:50%;transform:translateY(-50%);
  border:4px solid transparent;border-bottom-color:var(--text-muted);margin-top:-5px;
  opacity:0.3;transition:opacity var(--transition);
}
thead th.sortable::before{
  content:'';position:absolute;right:8px;top:50%;transform:translateY(-50%);
  border:4px solid transparent;border-top-color:var(--text-muted);margin-top:3px;
  opacity:0.3;transition:opacity var(--transition);
}
thead th.sortable.sort-asc{color:var(--text-primary)}
thead th.sortable.sort-asc::after{opacity:1;border-bottom-color:var(--red)}
thead th.sortable.sort-asc::before{opacity:0.15}
thead th.sortable.sort-desc{color:var(--text-primary)}
thead th.sortable.sort-desc::before{opacity:1;border-top-color:var(--red)}
thead th.sortable.sort-desc::after{opacity:0.15}
tbody tr{border-bottom:1px solid var(--border-color);transition:background var(--transition)}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--bg-hover)}
tbody td{padding:12px 16px;font-size:0.9rem;white-space:nowrap}
td.item-cell{white-space:normal;min-width:160px;max-width:240px}
.qty-badge{
  display:inline-flex;align-items:center;justify-content:center;
  background:var(--bg-tertiary);color:var(--text-secondary);
  font-size:0.75rem;font-weight:600;min-width:24px;height:22px;
  padding:0 6px;border-radius:4px;
}
.source-badge{
  display:inline-flex;align-items:center;padding:4px 10px;border-radius:50px;
  font-size:0.75rem;font-weight:600;text-transform:capitalize;
}
.source-badge.store{background:rgba(59,130,246,0.12);color:var(--store-color)}
.source-badge.online{background:rgba(139,92,246,0.12);color:var(--online-color)}
.source-badge.market{background:rgba(16,185,129,0.12);color:var(--market-color)}
.actions-cell{display:flex;gap:4px}

/* Pagination */
.pagination{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:12px 16px;border-top:1px solid var(--border-color);
}
.pagination button{
  min-width:36px;height:36px;border-radius:var(--radius-sm);
  border:1px solid var(--border-color);background:var(--bg-secondary);
  color:var(--text-secondary);font-size:0.85rem;cursor:pointer;transition:var(--transition);
  display:flex;align-items:center;justify-content:center;
}
.pagination button:hover:not(:disabled){background:var(--bg-hover);color:var(--text-primary)}
.pagination button.active{background:var(--red);color:#fff;border-color:var(--red)}
.pagination button:disabled{opacity:0.4;cursor:not-allowed}

/* Empty State */
.empty-state{text-align:center;padding:60px 20px}
.empty-state svg{width:64px;height:64px;color:var(--text-muted);margin-bottom:16px}
.empty-state h3{font-family:var(--font-display);font-weight:700;font-size:1.1rem;margin-bottom:8px}
.empty-state p{color:var(--text-secondary);margin-bottom:20px;font-size:0.9rem}

/* Footer */
.footer{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:24px 0 40px;flex-wrap:wrap;
}

/* Modal Overlay */
.modal-overlay{
  position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:opacity 0.25s ease,visibility 0.25s ease;
  padding:20px;
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:14px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;
  transform:translateY(20px) scale(0.97);transition:transform 0.25s ease;
  box-shadow:var(--shadow-lg);
}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 24px;border-bottom:1px solid var(--border-color);
}
.modal-header h2{font-family:var(--font-display);font-weight:700;font-size:1.15rem}
.modal-body{padding:24px}
.modal-footer{
  display:flex;gap:10px;justify-content:flex-end;
  padding:16px 24px;border-top:1px solid var(--border-color);
}

/* Form */
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:0.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em}
.form-group input,.form-group select,.form-group textarea{
  width:100%;background:var(--bg-primary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:10px 12px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.9rem;transition:var(--transition);
  min-height:44px;
}
.form-group textarea{min-height:80px;resize:vertical}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{
  outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(255,28,28,0.1);
}
.form-group select{cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;
}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.store-name-wrap{display:flex;gap:8px}
.store-name-wrap select{flex:1}
.store-name-wrap .btn-add-store{
  flex-shrink:0;width:44px;height:44px;border-radius:var(--radius-sm);
  background:var(--bg-tertiary);border:1px solid var(--border-color);
  color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;
  justify-content:center;transition:var(--transition);font-size:1.2rem;
}
.store-name-wrap .btn-add-store:hover{color:var(--text-primary);border-color:var(--text-muted)}
.store-tag{
  display:inline-flex;align-items:center;gap:2px;
  font-size:0.72rem;color:var(--text-muted);max-width:100px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.price-input-wrap{position:relative}
.price-input-wrap .currency-label{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  color:var(--text-muted);font-weight:600;font-size:0.9rem;pointer-events:none;
}
.price-input-wrap input{padding-left:28px}
.auto-calc{font-size:0.75rem;color:var(--text-muted);margin-top:4px;font-style:italic}

/* Confirm Dialog */
.confirm-overlay{
  position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:opacity 0.2s ease,visibility 0.2s ease;
  padding:20px;
}
.confirm-overlay.open{opacity:1;visibility:visible}
.confirm-dialog{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:14px;padding:28px;max-width:380px;width:100%;text-align:center;
  transform:scale(0.95);transition:transform 0.2s ease;box-shadow:var(--shadow-lg);
}
.confirm-overlay.open .confirm-dialog{transform:scale(1)}
.confirm-dialog h3{font-family:var(--font-display);margin-bottom:8px;font-size:1.1rem}
.confirm-dialog p{color:var(--text-secondary);font-size:0.9rem;margin-bottom:20px}
.confirm-dialog .btn-row{display:flex;gap:10px;justify-content:center}

/* Loader */
.loader{display:flex;align-items:center;justify-content:center;padding:60px}
.pokeball-spinner{width:48px;height:48px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:400;
  background:var(--bg-tertiary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:12px 20px;
  font-size:0.85rem;color:var(--text-primary);
  box-shadow:var(--shadow-lg);
  transform:translateY(100px);opacity:0;transition:all 0.3s ease;
  pointer-events:none;max-width:340px;
}
.toast.show{transform:translateY(0);opacity:1}

/* Responsive */
@media(max-width:900px){
  .dashboard{grid-template-columns:repeat(2,1fr)}
  /* Date + actions on same line (HTML puts actions in first cell when viewport <= 900px) */
  #purchases-table .date-with-actions,
  #ct-table .date-with-actions{
    display:flex !important;
    flex-wrap:nowrap;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  #purchases-table .date-with-actions .actions-cell,
  #ct-table .date-with-actions .actions-cell{
    margin-left:auto;
    flex-shrink:0;
  }
  #purchases-table .actions-col-placeholder,
  #ct-table .actions-col-placeholder{
    display:none !important;
  }
}
@media(max-width:640px){
  /* --- Mobile Header --- */
  .header{padding:12px 0}
  .header-inner{
    gap:8px;
    display:grid;
    grid-template-columns:1fr auto;
    grid-template-rows:auto auto;
    align-items:center;
  }
  .logo{grid-column:1;grid-row:1}
  .logo svg{width:28px;height:28px}
  .logo-text{font-size:1.15rem}
  .header-actions{
    grid-column:1 / -1;grid-row:2;
    display:flex;align-items:center;gap:6px;
    width:100%;justify-content:space-between;
    padding-top:4px;
  }
  .theme-toggle{
    grid-column:2;grid-row:1;
    width:34px;height:34px;
    position:static;
  }
  .theme-toggle svg{width:15px;height:15px}
  .currency-toggle{padding:2px}
  .currency-toggle button{padding:5px 10px;font-size:0.75rem;min-width:38px;min-height:30px}
  .header-actions .btn-primary{
    padding:8px 14px;font-size:0.8rem;
    white-space:nowrap;flex-shrink:0;
  }
  .header-actions .btn-primary svg{width:14px;height:14px}

  /* --- General --- */
  .dashboard{grid-template-columns:1fr 1fr;gap:10px}
  .card{padding:14px}
  .card-label{font-size:0.6rem}
  .card-value{font-size:1.2rem}
  .card-sub{font-size:0.65rem}
  .chart-container{height:200px}
  .form-row,.form-row-3{grid-template-columns:1fr}
  .filter-bar{flex-direction:column;align-items:stretch}
  .search-wrap{min-width:unset}
  .date-filter{width:100%}
  .modal{max-width:100%;border-radius:14px 14px 0 0;max-height:95vh;align-self:flex-end}
  .modal-overlay{padding:0;align-items:flex-end}
  .footer{flex-direction:column}
  .footer .btn{font-size:0.8rem;padding:10px 16px}

  /* --- Mobile card layout: force block so flex works in Safari --- */
  #purchases-table,#ct-table{display:block !important;min-width:0 !important}
  #purchases-table thead,#ct-table thead{display:none}
  #purchases-table tbody,#ct-table tbody{display:block !important}
  #purchases-table tbody tr,#ct-table tbody tr{
    display:flex !important;
    flex-wrap:wrap;
    gap:6px 8px;
    padding:8px 10px;margin:4px 0;
    border:1px solid var(--border-color);
    border-radius:var(--radius-sm);
    background:var(--bg-secondary);
    align-items:center;
    width:100%;
    box-sizing:border-box;
  }
  #purchases-table tbody td,#ct-table tbody td{
    display:flex !important;align-items:center;gap:3px;
    padding:2px 0;white-space:normal;border:none;
    font-size:0.72rem;min-height:18px;
    overflow:hidden;text-overflow:ellipsis;
    box-sizing:border-box;
  }
  #purchases-table tbody td::before,#ct-table tbody td::before{
    content:attr(data-label);
    font-weight:700;font-size:0.5rem;color:var(--text-muted);
    text-transform:uppercase;letter-spacing:0.03em;
    flex-shrink:0;margin-right:3px;white-space:nowrap;
  }
  #purchases-table tbody td[data-label=""],#ct-table tbody td[data-label=""]{padding:0}
  #purchases-table tbody td[data-label=""]::before,#ct-table tbody td[data-label=""]::before{display:none}
  #purchases-table tbody td.actions-col-placeholder,#ct-table tbody td.actions-col-placeholder{display:none !important}
  /* Row 1: Date + Edit/Delete on same line */
  #purchases-table tbody td:first-child,#ct-table tbody td:first-child{
    order:1;flex:1 1 0;min-width:0;max-width:none;
    font-size:0.76rem;
    padding-bottom:3px;margin-bottom:2px;
    border-bottom:1px solid var(--border-color);
    justify-content:space-between;
    width:100%;flex-basis:100%;
  }
  #purchases-table tbody td:first-child .actions-cell,#ct-table tbody td:first-child .actions-cell{
    flex-shrink:0;margin-left:auto;gap:2px;
  }
  #purchases-table tbody td:first-child .actions-cell .btn-icon,#ct-table tbody td:first-child .actions-cell .btn-icon{
    width:26px;height:26px;
  }
  #purchases-table tbody td:last-child,#ct-table tbody td:last-child{
    order:2;flex:0 0 auto;
    justify-content:flex-end;
    padding-bottom:3px;margin-bottom:2px;
    border-bottom:1px solid var(--border-color);
  }
  #purchases-table tbody td:last-child::before,#ct-table tbody td:last-child::before{display:none}
  #purchases-table tbody td:nth-child(2),#ct-table tbody td:nth-child(2){order:3;flex:1 1 100%;font-size:0.74rem;min-width:0}
  #purchases-table td.item-cell,#ct-table td.item-cell{min-width:unset;max-width:unset}
  #purchases-table tbody td:nth-child(3),#ct-table tbody td:nth-child(3){order:4;flex:1 1 45%}
  #purchases-table tbody td:nth-child(4),#ct-table tbody td:nth-child(4){order:5;flex:1 1 45%}
  #purchases-table tbody td:nth-child(5),#ct-table tbody td:nth-child(5){order:6;flex:1 1 45%}
  #purchases-table tbody td:nth-child(6),#ct-table tbody td:nth-child(6){order:7;flex:1 1 45%}
  #purchases-table tbody td:nth-child(7){order:8;flex:1 1 45%}
  #purchases-table tbody td:nth-child(8){order:9;flex:1 1 45%}
  #ct-table tbody td:nth-child(5),#ct-table tbody td:nth-child(6){font-size:0.68rem}
  /* Pull rates table: keep card layout but no order reorder */
  #ct-pull-table{display:block !important;min-width:0 !important}
  #ct-pull-table thead{display:none}
  #ct-pull-table tbody{display:block !important}
  #ct-pull-table tbody tr{display:flex !important;flex-wrap:wrap;gap:6px 8px;padding:8px 10px;margin:4px 0;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-secondary);align-items:center;width:100%;box-sizing:border-box}
  #ct-pull-table tbody td{display:flex !important;align-items:center;gap:3px;padding:2px 0;border:none;font-size:0.72rem;min-height:18px;box-sizing:border-box}
  #ct-pull-table tbody td::before{content:attr(data-label);font-weight:700;font-size:0.5rem;color:var(--text-muted);text-transform:uppercase;margin-right:3px;white-space:nowrap}
  .table-scroll{overflow-x:visible}
  .table-wrap{border:none;background:none}
  .actions-cell{gap:6px}
  .actions-cell .btn-icon{width:28px;height:28px;background:var(--bg-tertiary);border-radius:4px}
  .badge{font-size:0.6rem;padding:1px 5px}
}
@media(max-width:400px){
  .dashboard{grid-template-columns:1fr}
}

/* Main Tab Navigation */
.main-tabs{
  display:flex;gap:0;padding-top:0;padding-bottom:0;
  border-bottom:1px solid var(--border-color);
  position:relative;z-index:1;
}
.main-tab{
  padding:14px 28px;background:none;border:none;
  border-bottom:3px solid transparent;color:var(--text-secondary);
  font-family:var(--font-display);font-weight:700;font-size:0.95rem;
  cursor:pointer;transition:var(--transition);
  display:flex;align-items:center;gap:8px;
}
.main-tab:hover{color:var(--text-primary)}
.main-tab.active{color:var(--red);border-bottom-color:var(--red)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Sub-tabs */
.sub-tabs{
  display:flex;gap:4px;margin-bottom:20px;
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius);padding:4px;width:fit-content;
}
.sub-tab{
  padding:8px 20px;border-radius:var(--radius-sm);border:none;
  background:transparent;color:var(--text-secondary);
  font-family:var(--font-body);font-weight:600;font-size:0.85rem;
  cursor:pointer;transition:var(--transition);
}
.sub-tab:hover{color:var(--text-primary)}
.sub-tab.active{background:var(--red);color:#fff}
.sub-content{display:none}
.sub-content.active{display:block}

/* Card Tracker specific */
.ct-dashboard{
  display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:24px 0;
}
.ct-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 0 0;flex-wrap:wrap;gap:12px;
}
.ct-header h2{
  font-family:var(--font-display);font-weight:700;font-size:1.3rem;margin:0;
}
.ct-checkbox-row{display:flex;gap:24px;margin-bottom:18px}
.ct-checkbox{
  display:flex;align-items:center;gap:8px;cursor:pointer;
  font-size:0.9rem;color:var(--text-primary);user-select:none;
}
.ct-checkbox input[type="checkbox"]{
  width:18px;height:18px;accent-color:var(--red);cursor:pointer;
}
.pull-rate-cards{
  display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px;
}
.weight-cell{font-variant-numeric:tabular-nums;font-family:var(--font-body)}
.badge{
  display:inline-flex;align-items:center;justify-content:center;
  padding:3px 10px;border-radius:50px;font-size:0.75rem;font-weight:600;
}
.badge-yes{background:rgba(16,185,129,0.12);color:var(--market-color)}
.badge-no{background:rgba(139,92,246,0.06);color:var(--text-muted)}
.badge-bipped{background:rgba(255,203,5,0.12);color:var(--yellow)}
.filter-row{
  display:flex;gap:12px;margin-bottom:16px;align-items:center;flex-wrap:wrap;
}
.filter-row select{
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:8px 32px 8px 12px;color:var(--text-primary);
  font-family:var(--font-body);font-size:0.85rem;min-height:40px;
  cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  transition:var(--transition);
}
.filter-row select:focus{outline:none;border-color:var(--red)}

/* Mobile sort row (visible when table headers are hidden) */
.ct-sort-mobile{
  display:none;
  align-items:center;gap:10px;margin-bottom:12px;
}
.ct-sort-mobile label{font-size:0.85rem;font-weight:600;color:var(--text-secondary)}
.ct-sort-mobile select{
  flex:1;min-width:0;max-width:220px;
  background:var(--bg-secondary);border:1px solid var(--border-color);
  border-radius:var(--radius-sm);padding:8px 32px 8px 12px;
  font-size:0.85rem;color:var(--text-primary);cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
}
@media(max-width:640px){
  .ct-sort-mobile{display:flex}
}

@media(max-width:900px){
  .ct-dashboard{grid-template-columns:repeat(2,1fr)}
  .pull-rate-cards{grid-template-columns:1fr 1fr}
}
@media(max-width:640px){
  .ct-dashboard{grid-template-columns:1fr 1fr;gap:10px}
  .pull-rate-cards{grid-template-columns:1fr}
  .main-tab{padding:10px 16px;font-size:0.85rem}
  .main-tabs{border-bottom:2px solid var(--border-color)}
  .filter-row{flex-direction:column;align-items:stretch}
  .ct-header{padding:14px 0 0}
  .ct-header h2{font-size:1.1rem}
  .ct-header .btn-primary{padding:8px 14px;font-size:0.8rem}
  .sub-tabs{width:100%}
  .sub-tab{flex:1;text-align:center;padding:8px 12px;font-size:0.8rem}
}
@media(max-width:400px){
  .ct-dashboard{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="container header-inner">
    <div class="logo">
      <svg class="logo-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="poke-red" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FF5555"/>
            <stop offset="100%" stop-color="#DD2222"/>
          </linearGradient>
          <linearGradient id="poke-btn" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#e0e0e0"/>
          </linearGradient>
        </defs>
        <circle cx="50" cy="50" r="46" stroke="#fff" stroke-width="2.5" fill="none"/>
        <path d="M4 50 A46 46 0 0 1 96 50 L4 50 Z" fill="url(#poke-red)"/>
        <path d="M4 50 A46 46 0 0 0 96 50 L4 50 Z" fill="#fff"/>
        <rect x="4" y="48" width="92" height="4" fill="#333"/>
        <circle cx="50" cy="50" r="14" fill="url(#poke-btn)" stroke="#333" stroke-width="2"/>
        <circle cx="50" cy="50" r="6" fill="#FF1C1C"/>
      </svg>
      <div class="logo-text">Poke<span>Tracker</span></div>
    </div>
    <button type="button" class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle light/dark mode" title="Toggle theme">
      <svg id="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="display:none"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <svg id="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
    </button>
    <div class="header-actions">
      <div class="currency-toggle" role="radiogroup" aria-label="Currency selection">
        <button type="button" id="btn-gbp" class="active" role="radio" aria-checked="true" onclick="setCurrency('gbp')">£ GBP</button>
        <button type="button" id="btn-eur" role="radio" aria-checked="false" onclick="setCurrency('eur')">€ EUR</button>
        <button type="button" id="btn-usd" role="radio" aria-checked="false" onclick="setCurrency('usd')">$ USD</button>
      </div>
      <button type="button" class="btn btn-primary" id="header-add-btn" onclick="headerAddAction()" aria-label="Add purchase">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        <span id="header-add-label">Add Purchase</span>
      </button>
    </div>
  </div>
</header>

<!-- Main Navigation Tabs -->
<nav class="main-tabs container" role="tablist" aria-label="Main navigation">
  <button type="button" class="main-tab active" data-tab="spending" role="tab" aria-selected="true" onclick="switchMainTab('spending')">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
    Spending
  </button>
  <button type="button" class="main-tab" data-tab="cards" role="tab" aria-selected="false" onclick="switchMainTab('cards')">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M8 7v10M12 7v10M16 7v10"/></svg>
    Card Tracker
  </button>
</nav>

<!-- Spending Tracker Tab -->
<div id="tab-spending" class="tab-content active">
<main class="container">

  <!-- Rate Status Bar -->
  <div class="rate-status" id="rate-status" style="margin-top:16px">
    <span>Exchange Rates:</span>
    <span class="rate-pill" id="rate-gbp-eur"><span class="dot live"></span> 1 GBP = ... EUR</span>
    <span class="rate-pill" id="rate-gbp-usd"><span class="dot live"></span> 1 GBP = ... USD</span>
    <button type="button" onclick="fetchRates()" id="rate-refresh-btn">Refresh</button>
    <span id="rate-timestamp" style="margin-left:auto;font-size:0.75rem;color:var(--text-muted)"></span>
  </div>

  <!-- Dashboard Cards -->
  <section class="dashboard" aria-label="Spending summary">
    <div class="card">
      <div class="card-icon red" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      </div>
      <div class="card-label">Total Spent</div>
      <div class="card-value" id="total-spent">--</div>
      <div class="card-sub" id="total-spent-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon yellow" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </div>
      <div class="card-label" id="period-label">This Period</div>
      <div class="card-value" id="month-spent">--</div>
      <div class="card-sub" id="month-spent-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon blue" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 110-4h12V0"/><path d="M20 12v4H6a2 2 0 100 4h12v4"/></svg>
      </div>
      <div class="card-label">Total Items</div>
      <div class="card-value" id="purchase-count">--</div>
      <div class="card-sub" id="purchase-count-sub"></div>
    </div>
    <div class="card">
      <div class="card-icon green" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div class="card-label">Source Breakdown</div>
      <div class="source-breakdown" id="source-breakdown"></div>
    </div>
  </section>

  <!-- Monthly Spending Chart -->
  <section class="chart-section">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px">
      <h2 id="chart-title" style="margin-bottom:0">Spending</h2>
      <div class="currency-toggle" role="radiogroup" aria-label="Period mode">
        <button type="button" id="btn-period-month" onclick="setPeriodMode('month')" style="font-size:0.78rem;padding:5px 12px;min-width:auto;min-height:30px">Month</button>
        <button type="button" id="btn-period-payday" class="active" onclick="setPeriodMode('payday')" style="font-size:0.78rem;padding:5px 12px;min-width:auto;min-height:30px">23 – 23</button>
      </div>
    </div>
    <div id="chart-period-hint" style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px"></div>
    <div class="chart-container">
      <canvas id="monthly-chart" aria-label="Monthly spending bar chart"></canvas>
    </div>
  </section>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="search-input" placeholder="Search by item name..." aria-label="Search purchases" oninput="applyFilters()">
    </div>
    <div class="filter-pills" role="group" aria-label="Filter by source">
      <button type="button" class="pill active" data-source="all" onclick="setSourceFilter('all',this)">All</button>
      <button type="button" class="pill" data-source="store" onclick="setSourceFilter('store',this)">Store</button>
      <button type="button" class="pill" data-source="online" onclick="setSourceFilter('online',this)">Online</button>
      <button type="button" class="pill" data-source="market" onclick="setSourceFilter('market',this)">Market</button>
    </div>
  </div>

  <!-- Date Range Filter -->
  <div class="date-filter">
    <label for="date-from">From</label>
    <input type="date" id="date-from" onchange="applyFilters()">
    <label for="date-to">To</label>
    <input type="date" id="date-to" onchange="applyFilters()">
    <button type="button" class="btn-clear" onclick="clearDateFilter()">Clear dates</button>
  </div>

  <!-- Table -->
  <div class="table-wrap" style="margin-top:16px">
    <div class="table-scroll">
      <table id="purchases-table" aria-label="Purchases list">
        <thead>
          <tr>
            <th class="sortable sort-desc" data-sort="date" onclick="sortSpending('date',this)">Date</th>
            <th class="sortable" data-sort="item" onclick="sortSpending('item',this)">Item</th>
            <th class="sortable" data-sort="qty" onclick="sortSpending('qty',this)">Qty</th>
            <th class="sortable" data-sort="price" onclick="sortSpending('price',this)">Unit Price</th>
            <th class="sortable" data-sort="total" onclick="sortSpending('total',this)">Total</th>
            <th class="sortable" data-sort="source" onclick="sortSpending('source',this)">Source</th>
            <th class="sortable" data-sort="delivery" onclick="sortSpending('delivery',this)">Delivery</th>
            <th class="sortable" data-sort="store" onclick="sortSpending('store',this)">Store</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div id="empty-state" class="empty-state" style="display:none">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="2" opacity="0.3"/>
        <rect x="2" y="48" width="96" height="4" fill="currentColor" opacity="0.3"/>
        <circle cx="50" cy="50" r="12" stroke="currentColor" stroke-width="2" opacity="0.3"/>
      </svg>
      <h3>No purchases yet</h3>
      <p>Add your first Pokemon card purchase to get started!</p>
      <button type="button" class="btn btn-primary" onclick="openAddModal()">Add Purchase</button>
    </div>
    <div id="no-results" class="empty-state" style="display:none">
      <h3>No matching purchases</h3>
      <p>Try adjusting your search, filters, or date range.</p>
    </div>
    <div id="pagination" class="pagination"></div>
  </div>

  <!-- Loader -->
  <div id="loader" class="loader" style="display:none">
    <svg class="pokeball-spinner" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Loading">
      <circle cx="50" cy="50" r="48" stroke="#FF1C1C" stroke-width="4"/>
      <rect x="2" y="48" width="96" height="4" fill="#FF1C1C"/>
      <circle cx="50" cy="50" r="12" fill="#0d1117" stroke="#FF1C1C" stroke-width="4"/>
      <circle cx="50" cy="50" r="6" fill="#FF1C1C"/>
      <path d="M2 50 A48 48 0 0 1 98 50" fill="#FF1C1C" opacity="0.2"/>
    </svg>
  </div>
</main>

<!-- Footer -->
<footer class="footer container">
  <button type="button" class="btn btn-secondary" onclick="exportJSON()" aria-label="Export JSON data">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Export JSON
  </button>
  <label class="btn btn-secondary" tabindex="0" role="button" style="cursor:pointer" onkeydown="if(event.key==='Enter')this.querySelector('input').click()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    Import JSON
    <input type="file" accept=".json,application/json" style="display:none" onchange="importJSON(event)" aria-label="Import JSON file">
  </label>
</footer>
</div><!-- end tab-spending -->

<!-- Card Tracker Tab -->
<div id="tab-cards" class="tab-content">
<main class="container">

  <!-- Card Tracker Header -->
  <div class="ct-header">
    <h2>Card Weight & Pull Rate Tracker</h2>
    <button type="button" class="btn btn-primary" onclick="openCardModal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Card Entry
    </button>
  </div>

  <!-- Card Tracker Dashboard -->
  <section class="ct-dashboard" aria-label="Card tracking summary">
    <div class="card">
      <div class="card-icon blue" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 110-4h12V0"/><path d="M20 12v4H6a2 2 0 100 4h12v4"/></svg>
      </div>
      <div class="card-label">Total Packs</div>
      <div class="card-value" id="ct-total-packs">0</div>
      <div class="card-sub" id="ct-total-packs-sub">packs opened</div>
    </div>
    <div class="card">
      <div class="card-icon yellow" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      </div>
      <div class="card-label">Series Tracked</div>
      <div class="card-value" id="ct-series-count">0</div>
      <div class="card-sub" id="ct-series-count-sub">unique series</div>
    </div>
    <div class="card">
      <div class="card-icon green" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div class="card-label">Pull Rate</div>
      <div class="card-value" id="ct-pull-rate">0%</div>
      <div class="card-sub" id="ct-pull-rate-sub">rare card rate</div>
    </div>
    <div class="card">
      <div class="card-icon red" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      </div>
      <div class="card-label">Avg Weight</div>
      <div class="card-value" id="ct-avg-weight">0g</div>
      <div class="card-sub" id="ct-avg-weight-sub">per pack</div>
    </div>
  </section>

  <!-- Sub-tabs -->
  <div class="sub-tabs" role="tablist">
    <button type="button" class="sub-tab active" role="tab" onclick="switchCardSubTab('all-cards',this)">All Cards</button>
    <button type="button" class="sub-tab" role="tab" onclick="switchCardSubTab('pull-rates',this)">Pull Rates</button>
  </div>

  <!-- All Cards Sub-tab -->
  <div id="sub-all-cards" class="sub-content active">
    <!-- Filter -->
    <div class="filter-row">
      <select id="ct-series-filter" onchange="renderCardTable()" aria-label="Filter by series">
        <option value="all">All Series</option>
      </select>
      <div class="search-wrap" style="flex:1;min-width:180px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="ct-search" placeholder="Search by series or cover..." aria-label="Search cards" oninput="renderCardTable()">
      </div>
    </div>

    <!-- Mobile sort (visible on small screens when table headers are hidden) -->
    <div class="ct-sort-mobile" aria-label="Sort cards">
      <label for="ct-sort-select">Sort by</label>
      <select id="ct-sort-select" onchange="ctSortFromMobile(this)" aria-label="Sort order">
        <option value="date-desc">Date (newest first)</option>
        <option value="date-asc">Date (oldest first)</option>
        <option value="series-asc">Series A–Z</option>
        <option value="series-desc">Series Z–A</option>
        <option value="weight-desc">Weight (high first)</option>
        <option value="weight-asc">Weight (low first)</option>
        <option value="cover-asc">Cover A–Z</option>
        <option value="cover-desc">Cover Z–A</option>
        <option value="rare-desc">Rare first</option>
        <option value="rare-asc">No rare first</option>
        <option value="bipped-desc">Bipped first</option>
        <option value="bipped-asc">No bip first</option>
      </select>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <div class="table-scroll">
        <table id="ct-table" aria-label="Card entries list">
          <thead>
            <tr>
              <th class="sortable sort-desc" data-sort="date" onclick="sortCards('date',this)">Date</th>
              <th class="sortable" data-sort="series" onclick="sortCards('series',this)">Series</th>
              <th class="sortable" data-sort="weight" onclick="sortCards('weight',this)">Weight</th>
              <th class="sortable" data-sort="cover" onclick="sortCards('cover',this)">Cover</th>
              <th class="sortable" data-sort="bipped" onclick="sortCards('bipped',this)">Bipped</th>
              <th class="sortable" data-sort="rare" onclick="sortCards('rare',this)">Had Rare</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ct-table-body"></tbody>
        </table>
      </div>
      <div id="ct-empty" class="empty-state" style="display:none">
        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="2" opacity="0.3"/>
          <rect x="2" y="48" width="96" height="4" fill="currentColor" opacity="0.3"/>
          <circle cx="50" cy="50" r="12" stroke="currentColor" stroke-width="2" opacity="0.3"/>
        </svg>
        <h3>No card entries yet</h3>
        <p>Add your first card entry to start tracking weights and pull rates!</p>
        <button type="button" class="btn btn-primary" onclick="openCardModal()">Add Card Entry</button>
      </div>
      <div id="ct-no-results" class="empty-state" style="display:none">
        <h3>No matching entries</h3>
        <p>Try adjusting your search or filter.</p>
      </div>
      <div id="ct-pagination" class="pagination"></div>
    </div>
  </div>

  <!-- Pull Rates Sub-tab -->
  <div id="sub-pull-rates" class="sub-content">
    <div class="table-wrap">
      <div class="table-scroll">
        <table id="ct-pull-table" aria-label="Pull rates by series">
          <thead>
            <tr>
              <th class="sortable sort-asc" data-sort="series" onclick="sortPullRates('series',this)">Series</th>
              <th class="sortable" data-sort="total" onclick="sortPullRates('total',this)">Total Packs</th>
              <th class="sortable" data-sort="rares" onclick="sortPullRates('rares',this)">Rare Count</th>
              <th class="sortable" data-sort="weight" onclick="sortPullRates('weight',this)">Avg Weight</th>
              <th class="sortable" data-sort="rate" onclick="sortPullRates('rate',this)">Pull Rate</th>
            </tr>
          </thead>
          <tbody id="ct-pull-body"></tbody>
        </table>
      </div>
      <div id="ct-pull-empty" class="empty-state" style="display:none">
        <h3>No data available</h3>
        <p>Add some card entries to see pull rate analytics.</p>
      </div>
    </div>
    <div class="pull-rate-cards" id="ct-pull-summary"></div>
  </div>

</main>

<!-- Card Tracker Footer -->
<footer class="footer container">
  <button type="button" class="btn btn-secondary" onclick="exportCardJSON()" aria-label="Export card entries">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Export Cards JSON
  </button>
  <label class="btn btn-secondary" tabindex="0" role="button" style="cursor:pointer" onkeydown="if(event.key==='Enter')this.querySelector('input').click()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
    Import Cards JSON
    <input type="file" accept=".json,application/json" style="display:none" onchange="importCardJSON(event)" aria-label="Import card entries file">
  </label>
</footer>
</div><!-- end tab-cards -->

<!-- Add/Edit Modal (Spending) -->
<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Add Purchase</h2>
      <button type="button" class="btn-icon" onclick="closeModal()" aria-label="Close modal">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="purchase-form" onsubmit="savePurchase(event)">
        <input type="hidden" id="form-id" value="">
        <div class="form-group">
          <label for="form-date">Date</label>
          <input type="date" id="form-date" required>
        </div>
        <div class="form-group">
          <label for="form-item">Item Name</label>
          <input type="text" id="form-item" placeholder="e.g. Charizard VMAX Alt Art" required>
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label for="form-currency">Currency</label>
            <select id="form-currency" onchange="recalcPrice()">
              <option value="gbp">£ GBP</option>
              <option value="eur">€ EUR</option>
              <option value="usd">$ USD</option>
            </select>
          </div>
          <div class="form-group">
            <label for="form-price">Unit Price</label>
            <div class="price-input-wrap">
              <span class="currency-label" id="form-currency-symbol">&pound;</span>
              <input type="number" id="form-price" step="0.01" min="0" placeholder="0.00" required oninput="recalcPrice()">
            </div>
          </div>
          <div class="form-group">
            <label for="form-quantity">Quantity</label>
            <input type="number" id="form-quantity" min="1" step="1" value="1" required oninput="recalcPrice()">
          </div>
        </div>
        <div class="auto-calc" id="form-auto-calc" style="margin-top:-10px;margin-bottom:16px"></div>
        <div class="form-row">
          <div class="form-group">
            <label for="form-source">Source Type</label>
            <select id="form-source" required onchange="toggleDeliveryFee()">
              <option value="store">Store</option>
              <option value="online">Online</option>
              <option value="market">Market</option>
            </select>
          </div>
          <div class="form-group">
            <label for="form-store-name">Store Name</label>
            <div class="store-name-wrap">
              <select id="form-store-name">
                <option value="">-- Select store --</option>
              </select>
              <button type="button" class="btn-add-store" onclick="addNewStore()" aria-label="Add new store" title="Add new store">+</button>
            </div>
          </div>
        </div>
        <div class="form-group" id="delivery-fee-group" style="display:none">
          <label for="form-delivery-fee">Delivery Fee</label>
          <div class="price-input-wrap">
            <span class="currency-label" id="form-delivery-symbol">&pound;</span>
            <input type="number" id="form-delivery-fee" step="0.01" min="0" placeholder="0.00" value="" oninput="recalcPrice()">
          </div>
        </div>
        <div class="form-group">
          <label for="form-notes">Notes (optional)</label>
          <textarea id="form-notes" placeholder="Any notes about this purchase..." rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button type="submit" class="btn btn-primary" form="purchase-form" id="form-submit-btn">Add Purchase</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirm-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-desc">
  <div class="confirm-dialog">
    <h3 id="confirm-title">Delete Purchase?</h3>
    <p id="confirm-desc">This action cannot be undone.</p>
    <div class="btn-row">
      <button type="button" class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
    </div>
  </div>
</div>

<!-- Card Entry Modal -->
<div class="modal-overlay" id="card-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="card-modal-title">
  <div class="modal">
    <div class="modal-header">
      <h2 id="card-modal-title">Add Card Entry</h2>
      <button type="button" class="btn-icon" onclick="closeCardModal()" aria-label="Close modal">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="card-form" onsubmit="saveCardEntry(event)">
        <input type="hidden" id="card-form-id" value="">
        <div class="form-group">
          <label for="card-form-series">Series</label>
          <input type="text" id="card-form-series" list="series-datalist" placeholder="Type or select a series..." required>
          <datalist id="series-datalist"></datalist>
        </div>
        <div class="form-group">
          <label for="card-form-weight">Weight (grams)</label>
          <input type="number" id="card-form-weight" step="0.001" min="0" placeholder="0.000" required>
        </div>
        <div class="form-group">
          <label for="card-form-cover">Cover Picture / Pokemon Name</label>
          <input type="text" id="card-form-cover" list="cover-datalist" placeholder="Type or select...">
          <datalist id="cover-datalist"></datalist>
        </div>
        <div class="ct-checkbox-row">
          <label class="ct-checkbox">
            <input type="checkbox" id="card-form-bipped">
            Bipped (metal detector)
          </label>
          <label class="ct-checkbox">
            <input type="checkbox" id="card-form-rare">
            Had Rare Card
          </label>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeCardModal()">Cancel</button>
      <button type="submit" class="btn btn-primary" form="card-form" id="card-form-submit">Add Entry</button>
    </div>
  </div>
</div>

<!-- Card Delete Confirm -->
<div class="confirm-overlay" id="card-confirm-overlay" role="alertdialog" aria-modal="true">
  <div class="confirm-dialog">
    <h3>Delete Card Entry?</h3>
    <p id="card-confirm-desc">This action cannot be undone.</p>
    <div class="btn-row">
      <button type="button" class="btn btn-secondary" onclick="closeCardConfirm()">Cancel</button>
      <button type="button" class="btn btn-danger" id="card-confirm-delete-btn">Delete</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== State ===== */
let purchases = [];
let currency = 'gbp'; // 'gbp' | 'eur' | 'usd'
let searchQuery = '';
let sourceFilter = 'all';
let dateFrom = '';
let dateTo = '';
let currentPage = 1;
const PAGE_SIZE = 20;
let editingId = null;
let sortCol = 'date'; // spending table sort column
let sortDir = 'desc'; // spending table sort direction
let monthlyChart = null;
let periodMode = 'payday'; // 'month' or 'payday' (23-to-23)
let chartFilterActive = false; // whether chart click filter is active

// Exchange rates: everything relative to GBP as base
// Fallback rates used if API fails
let rates = { gbp: 1, eur: 1.17, usd: 1.26 };
let ratesLive = false;

// Store names list (persisted in localStorage)
let storeNames = [];

/* ===== Theme ===== */
// Apply theme immediately to prevent flash
(function() {
  const saved = localStorage.getItem('poketracker_theme');
  if (saved === 'light') document.body.classList.add('light-mode');
  // Also check system preference if no saved preference
  if (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.body.classList.add('light-mode');
  }
})();

function toggleTheme() {
  const isLight = document.body.classList.toggle('light-mode');
  localStorage.setItem('poketracker_theme', isLight ? 'light' : 'dark');
  updateThemeButton();
  updateThemeColor();
  // Re-render chart with correct colors
  if (monthlyChart) renderChart();
}

function updateThemeButton() {
  const isLight = document.body.classList.contains('light-mode');
  document.getElementById('theme-icon-sun').style.display = isLight ? 'block' : 'none';
  document.getElementById('theme-icon-moon').style.display = isLight ? 'none' : 'block';
  document.getElementById('theme-toggle').title = isLight ? 'Switch to dark mode' : 'Switch to light mode';
}

function updateThemeColor() {
  const isLight = document.body.classList.contains('light-mode');
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.content = isLight ? '#f5f6f8' : '#0d1117';
}

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', init);

var _lastMobileTable = null;
window.addEventListener('resize', function() {
  var m = isMobileTable();
  if (_lastMobileTable !== null && _lastMobileTable !== m) {
    _lastMobileTable = m;
    renderTable();
    renderCardAll();
  } else {
    _lastMobileTable = m;
  }
});

async function init() {
  updateThemeButton();
  updateThemeColor();
  updateHeaderAddButton('spending');
  showLoader(true);
  loadStoreNames();
  // Fetch rates and data in parallel
  const [ratesResult] = await Promise.allSettled([fetchRates(), loadData()]);
  // Collect any store names from existing purchases
  syncStoreNamesFromPurchases();
  showLoader(false);
  renderAll();
  initCardTracker();
  _lastMobileTable = isMobileTable();
}

async function loadData() {
  // Try localStorage first (persists user edits across refreshes)
  const saved = localStorage.getItem('poketracker_purchases');
  if (saved) {
    try {
      purchases = JSON.parse(saved);
      if (!Array.isArray(purchases)) purchases = [];
      migratePurchases();
      return;
    } catch (e) {
      console.warn('Invalid localStorage data, falling back to data.json');
    }
  }
  // Fall back to data.json (initial seed data)
  try {
    const res = await fetch('./data.json');
    if (!res.ok) throw new Error('Failed to load data');
    purchases = await res.json();
    if (!Array.isArray(purchases)) purchases = [];
    migratePurchases();
    saveToStorage();
  } catch (e) {
    console.warn('Could not load data.json:', e);
    purchases = [];
  }
}

function migratePurchases() {
  purchases.forEach(p => {
    if (!p.quantity) p.quantity = 1;
    if (p.price_usd === undefined) p.price_usd = parseFloat((p.price_gbp * rates.usd).toFixed(2));
    if (p.delivery_fee_gbp === undefined) p.delivery_fee_gbp = 0;
  });
}

function saveToStorage() {
  try {
    localStorage.setItem('poketracker_purchases', JSON.stringify(purchases));
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}

/* ===== Store Names ===== */
function loadStoreNames() {
  try {
    const saved = localStorage.getItem('poketracker_stores');
    if (saved) storeNames = JSON.parse(saved);
    if (!Array.isArray(storeNames)) storeNames = [];
  } catch (e) { storeNames = []; }
}

function saveStoreNames() {
  try {
    localStorage.setItem('poketracker_stores', JSON.stringify(storeNames));
  } catch (e) {}
}

function syncStoreNamesFromPurchases() {
  purchases.forEach(p => {
    if (p.store_name && !storeNames.includes(p.store_name)) {
      storeNames.push(p.store_name);
    }
  });
  storeNames.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
  saveStoreNames();
}

function populateStoreDropdown(selectedValue) {
  const sel = document.getElementById('form-store-name');
  sel.innerHTML = '<option value="">-- Select store --</option>';
  storeNames.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  if (selectedValue) sel.value = selectedValue;
}

function addNewStore() {
  const name = prompt('Enter new store name:');
  if (!name || !name.trim()) return;
  const trimmed = name.trim();
  if (!storeNames.includes(trimmed)) {
    storeNames.push(trimmed);
    storeNames.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    saveStoreNames();
  }
  populateStoreDropdown(trimmed);
}

async function fetchRates() {
  try {
    const res = await fetch('https://open.er-api.com/v6/latest/GBP');
    if (!res.ok) throw new Error('Rate API error');
    const data = await res.json();
    if (data && data.rates) {
      rates.eur = data.rates.EUR || rates.eur;
      rates.usd = data.rates.USD || rates.usd;
      ratesLive = true;
      updateRateDisplay();
      showToast('Live exchange rates loaded');
      return;
    }
  } catch (e) {
    console.warn('Rate API failed, using fallback rates:', e);
  }
  ratesLive = false;
  updateRateDisplay();
}

function updateRateDisplay() {
  const dotClass = ratesLive ? 'live' : 'fallback';
  const label = ratesLive ? 'Live' : 'Fallback';
  document.getElementById('rate-gbp-eur').innerHTML = `<span class="dot ${dotClass}"></span> 1 GBP = ${rates.eur.toFixed(4)} EUR`;
  document.getElementById('rate-gbp-usd').innerHTML = `<span class="dot ${dotClass}"></span> 1 GBP = ${rates.usd.toFixed(4)} USD`;
  document.getElementById('rate-timestamp').textContent = ratesLive ? 'Live rates' : 'Fallback rates';
}

function showLoader(show) {
  document.getElementById('loader').style.display = show ? 'flex' : 'none';
}

/* ===== Currency ===== */
function setCurrency(c) {
  currency = c;
  ['gbp', 'eur', 'usd'].forEach(cur => {
    const btn = document.getElementById('btn-' + cur);
    btn.classList.toggle('active', c === cur);
    btn.setAttribute('aria-checked', c === cur);
  });
  renderAll();
}

function convertToDisplay(priceGbp) {
  if (currency === 'gbp') return priceGbp;
  if (currency === 'eur') return priceGbp * rates.eur;
  return priceGbp * rates.usd;
}

function formatPrice(priceGbp) {
  const val = convertToDisplay(priceGbp);
  return currencySymbol() + val.toFixed(2);
}

function getDisplayPrice(entry) {
  return convertToDisplay(entry.price_gbp);
}

function currencySymbol() {
  if (currency === 'gbp') return '\u00A3';
  if (currency === 'eur') return '\u20AC';
  return '$';
}

/* ===== Render All ===== */
function renderAll() {
  renderDashboard();
  renderChart();
  renderTable();
}

/* ===== Dashboard ===== */
function renderDashboard() {
  const total = purchases.reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1) + convertToDisplay(e.delivery_fee_gbp || 0), 0);
  const now = new Date();
  let thisMonth, periodLabel;
  if (periodMode === 'payday') {
    // Current pay period: 23rd of last month to 22nd of this month
    const pStart = new Date(now.getFullYear(), now.getMonth() - 1, 23);
    const pEnd = new Date(now.getFullYear(), now.getMonth(), 22);
    const pStartStr = pStart.toISOString().split('T')[0];
    const pEndStr = pEnd.toISOString().split('T')[0];
    thisMonth = purchases.filter(e => e.date >= pStartStr && e.date <= pEndStr);
    periodLabel = 'this period';
  } else {
    thisMonth = purchases.filter(e => {
      const d = new Date(e.date);
      return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
    });
    periodLabel = 'this month';
  }
  const monthTotal = thisMonth.reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1) + convertToDisplay(e.delivery_fee_gbp || 0), 0);
  const totalItems = purchases.reduce((s, e) => s + (e.quantity || 1), 0);

  document.getElementById('total-spent').textContent = currencySymbol() + total.toFixed(2);
  document.getElementById('total-spent-sub').textContent = purchases.length + ' purchase' + (purchases.length !== 1 ? 's' : '') + ' total';
  document.getElementById('period-label').textContent = periodMode === 'payday' ? 'This Period' : 'This Month';
  document.getElementById('month-spent').textContent = currencySymbol() + monthTotal.toFixed(2);
  document.getElementById('month-spent-sub').textContent = thisMonth.length + ' purchase' + (thisMonth.length !== 1 ? 's' : '') + ' ' + periodLabel;
  document.getElementById('purchase-count').textContent = totalItems;
  document.getElementById('purchase-count-sub').textContent = purchases.length + ' line item' + (purchases.length !== 1 ? 's' : '');

  // Source breakdown by spend
  const spendBySource = { store: 0, online: 0, market: 0 };
  purchases.forEach(e => {
    if (spendBySource[e.source] !== undefined) {
      spendBySource[e.source] += getDisplayPrice(e) * (e.quantity || 1) + convertToDisplay(e.delivery_fee_gbp || 0);
    }
  });
  const totalSpend = total || 1;
  const breakdown = document.getElementById('source-breakdown');
  breakdown.innerHTML = ['store', 'online', 'market'].map(src => {
    const pct = Math.round((spendBySource[src] / totalSpend) * 100);
    return `<div class="source-bar-row">
      <span class="source-bar-label">${src.charAt(0).toUpperCase() + src.slice(1)}</span>
      <div class="source-bar-track"><div class="source-bar-fill ${src}" style="width:${pct}%"></div></div>
      <span class="source-bar-pct">${pct}%</span>
    </div>`;
  }).join('');
}

/* ===== Period Mode ===== */
function setPeriodMode(mode) {
  periodMode = mode;
  document.getElementById('btn-period-month').classList.toggle('active', mode === 'month');
  document.getElementById('btn-period-payday').classList.toggle('active', mode === 'payday');
  clearChartFilter();
  renderChart();
}

function clearChartFilter() {
  chartFilterActive = false;
  document.getElementById('chart-period-hint').textContent = '';
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  dateFrom = '';
  dateTo = '';
}

function getChartPeriods() {
  const now = new Date();
  const periods = [];

  if (periodMode === 'month') {
    for (let i = 11; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const start = new Date(d.getFullYear(), d.getMonth(), 1);
      const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
      periods.push({
        label: d.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }),
        startDate: start.toISOString().split('T')[0],
        endDate: end.toISOString().split('T')[0]
      });
    }
  } else {
    // Payday mode: 23rd of prev month to 22nd of current month
    for (let i = 11; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const start = new Date(d.getFullYear(), d.getMonth() - 1, 23);
      const end = new Date(d.getFullYear(), d.getMonth(), 22);
      const label = start.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ' – ' + end.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' });
      periods.push({
        label: d.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }),
        fullLabel: label,
        startDate: start.toISOString().split('T')[0],
        endDate: end.toISOString().split('T')[0]
      });
    }
  }
  return periods;
}

/* ===== Chart ===== */
function renderChart() {
  const canvas = document.getElementById('monthly-chart');
  const ctx = canvas.getContext('2d');

  const periods = getChartPeriods();
  const chartTitle = document.getElementById('chart-title');
  chartTitle.textContent = periodMode === 'month' ? 'Monthly Spending' : 'Payday Spending (23rd – 22nd)';

  const data = periods.map(p => {
    return purchases.filter(e => {
      return e.date >= p.startDate && e.date <= p.endDate;
    }).reduce((s, e) => s + getDisplayPrice(e) * (e.quantity || 1) + convertToDisplay(e.delivery_fee_gbp || 0), 0);
  });

  if (monthlyChart) monthlyChart.destroy();

  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(255, 28, 28, 0.8)');
  gradient.addColorStop(1, 'rgba(255, 28, 28, 0.15)');

  monthlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: periods.map(p => p.label),
      datasets: [{
        label: 'Spending',
        data: data,
        backgroundColor: gradient,
        borderColor: 'rgba(255, 28, 28, 0.9)',
        borderWidth: 1,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 600, easing: 'easeOutQuart' },
      onClick: function(evt, elements) {
        if (elements.length > 0) {
          const idx = elements[0].index;
          const period = periods[idx];
          // If clicking the same period that's already filtered, clear the filter
          if (chartFilterActive && dateFrom === period.startDate && dateTo === period.endDate) {
            clearChartFilter();
            currentPage = 1;
            renderTable();
            return;
          }
          chartFilterActive = true;
          dateFrom = period.startDate;
          dateTo = period.endDate;
          document.getElementById('date-from').value = period.startDate;
          document.getElementById('date-to').value = period.endDate;
          document.getElementById('chart-period-hint').textContent = 'Showing: ' + (period.fullLabel || period.label) + '  (click bar again to clear)';
          currentPage = 1;
          renderTable();
          document.querySelector('.table-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: document.body.classList.contains('light-mode') ? '#ffffff' : '#161b22',
          titleColor: document.body.classList.contains('light-mode') ? '#1f2328' : '#e6edf3',
          bodyColor: document.body.classList.contains('light-mode') ? '#1f2328' : '#e6edf3',
          borderColor: document.body.classList.contains('light-mode') ? '#d0d7de' : '#30363d',
          borderWidth: 1,
          cornerRadius: 8,
          padding: 12,
          callbacks: {
            title: function(items) {
              const idx = items[0].dataIndex;
              return periods[idx].fullLabel || periods[idx].label;
            },
            label: function(c) { return currencySymbol() + c.parsed.y.toFixed(2); }
          }
        }
      },
      scales: {
        x: {
          grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.06)' : 'rgba(48, 54, 61, 0.5)', drawBorder: false },
          ticks: { color: document.body.classList.contains('light-mode') ? '#656d76' : '#8b949e', font: { family: 'DM Sans', size: 11 } }
        },
        y: {
          beginAtZero: true,
          grid: { color: document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.06)' : 'rgba(48, 54, 61, 0.5)', drawBorder: false },
          ticks: {
            color: document.body.classList.contains('light-mode') ? '#656d76' : '#8b949e',
            font: { family: 'DM Sans', size: 11 },
            callback: function(val) { return currencySymbol() + val; }
          }
        }
      }
    }
  });
}

/* ===== Sorting helpers ===== */
function updateSortHeaders(tableId, col, dir) {
  const ths = document.querySelectorAll('#' + tableId + ' thead th.sortable');
  ths.forEach(th => {
    th.classList.remove('sort-asc', 'sort-desc');
    if (th.dataset.sort === col) th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');
  });
}

function sortSpending(col, thEl) {
  if (sortCol === col) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
  else { sortCol = col; sortDir = (col === 'date') ? 'desc' : 'asc'; }
  updateSortHeaders('purchases-table', sortCol, sortDir);
  currentPage = 1;
  renderTable();
}

/* ===== Table ===== */
function getFiltered() {
  let list = [...purchases];
  if (sourceFilter !== 'all') list = list.filter(e => e.source === sourceFilter);
  if (searchQuery.trim()) {
    const q = searchQuery.toLowerCase().trim();
    list = list.filter(e => e.item.toLowerCase().includes(q));
  }
  if (dateFrom) list = list.filter(e => e.date >= dateFrom);
  if (dateTo) list = list.filter(e => e.date <= dateTo);

  const dir = sortDir === 'asc' ? 1 : -1;
  list.sort((a, b) => {
    let va, vb;
    switch (sortCol) {
      case 'date': va = a.date; vb = b.date; break;
      case 'item': va = a.item.toLowerCase(); vb = b.item.toLowerCase(); break;
      case 'qty': va = a.quantity || 1; vb = b.quantity || 1; break;
      case 'price': va = getDisplayPrice(a); vb = getDisplayPrice(b); break;
      case 'total': va = getDisplayPrice(a) * (a.quantity || 1); vb = getDisplayPrice(b) * (b.quantity || 1); break;
      case 'source': va = a.source; vb = b.source; break;
      case 'delivery': va = a.delivery_fee_gbp || 0; vb = b.delivery_fee_gbp || 0; break;
      case 'store': va = (a.store_name || '').toLowerCase(); vb = (b.store_name || '').toLowerCase(); break;
      default: va = a.date; vb = b.date;
    }
    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });
  return list;
}

function renderTable() {
  const filtered = getFiltered();
  const tbody = document.getElementById('table-body');
  const emptyState = document.getElementById('empty-state');
  const noResults = document.getElementById('no-results');
  const tableEl = document.getElementById('purchases-table');
  const paginationEl = document.getElementById('pagination');

  if (purchases.length === 0) {
    tableEl.style.display = 'none';
    paginationEl.style.display = 'none';
    noResults.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';

  if (filtered.length === 0) {
    tableEl.style.display = 'none';
    paginationEl.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }
  noResults.style.display = 'none';
  tableEl.style.display = 'table';

  const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
  if (currentPage > totalPages) currentPage = totalPages;
  if (currentPage < 1) currentPage = 1;
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = filtered.slice(start, start + PAGE_SIZE);

  var mobile = isMobileTable();
  var actionsHtml = function(entry) {
    return '<div class="actions-cell">' +
      '<button type="button" class="btn-icon" onclick="openEditModal(\'' + entry.id + '\')" aria-label="Edit ' + escapeHtml(entry.item) + '">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
      '</button>' +
      '<button type="button" class="btn-icon delete" onclick="confirmDelete(\'' + entry.id + '\')" aria-label="Delete ' + escapeHtml(entry.item) + '">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>' +
      '</button></div>';
  };
  tbody.innerHTML = pageItems.map(entry => {
    const dateFormatted = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    const qty = entry.quantity || 1;
    const unitPrice = getDisplayPrice(entry);
    const lineTotal = unitPrice * qty;
    var firstTd = mobile
      ? '<td data-label="Date" class="date-with-actions">' + dateFormatted + actionsHtml(entry) + '</td>'
      : '<td data-label="Date">' + dateFormatted + '</td>';
    var lastTd = mobile
      ? '<td data-label="" class="actions-col-placeholder"></td>'
      : '<td data-label="">' + actionsHtml(entry) + '</td>';
    return '<tr>' +
      firstTd +
      '<td data-label="Item" class="item-cell">' + escapeHtml(entry.item) + '</td>' +
      '<td data-label="Qty"><span class="qty-badge">' + qty + '</span></td>' +
      '<td data-label="Price">' + currencySymbol() + unitPrice.toFixed(2) + '</td>' +
      '<td data-label="Total"><strong>' + currencySymbol() + lineTotal.toFixed(2) + '</strong></td>' +
      '<td data-label="Source"><span class="source-badge ' + entry.source + '">' + entry.source + '</span></td>' +
      '<td data-label="Delivery">' + (entry.delivery_fee_gbp ? currencySymbol() + convertToDisplay(entry.delivery_fee_gbp).toFixed(2) : '<span style="color:var(--text-muted)">-</span>') + '</td>' +
      '<td data-label="Store">' + (entry.store_name ? '<span class="store-tag" title="' + escapeHtml(entry.store_name) + '">' + escapeHtml(entry.store_name) + '</span>' : '<span class="store-tag">-</span>') + '</td>' +
      lastTd +
    '</tr>';
  }).join('');

  if (totalPages <= 1) {
    paginationEl.style.display = 'none';
  } else {
    paginationEl.style.display = 'flex';
    let html = `<button type="button" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})" aria-label="Previous page">&laquo;</button>`;
    for (let i = 1; i <= totalPages; i++) {
      if (totalPages > 7 && i > 2 && i < totalPages - 1 && Math.abs(i - currentPage) > 1) {
        if (i === 3 || i === totalPages - 2) html += `<button type="button" disabled>...</button>`;
        continue;
      }
      html += `<button type="button" class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    html += `<button type="button" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})" aria-label="Next page">&raquo;</button>`;
    paginationEl.innerHTML = html;
  }
}

function goToPage(page) {
  currentPage = page;
  renderTable();
  document.querySelector('.table-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function isMobileTable() {
  return window.matchMedia('(max-width:900px)').matches;
}

/* ===== Filters ===== */
function applyFilters() {
  searchQuery = document.getElementById('search-input').value;
  dateFrom = document.getElementById('date-from').value;
  dateTo = document.getElementById('date-to').value;
  currentPage = 1;
  renderTable();
}

function clearDateFilter() {
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  dateFrom = '';
  dateTo = '';
  chartFilterActive = false;
  document.getElementById('chart-period-hint').textContent = '';
  currentPage = 1;
  renderTable();
}

function setSourceFilter(source, el) {
  sourceFilter = source;
  document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  currentPage = 1;
  renderTable();
}

/* ===== Modal ===== */
function openAddModal() {
  editingId = null;
  document.getElementById('modal-title').textContent = 'Add Purchase';
  document.getElementById('form-submit-btn').textContent = 'Add Purchase';
  document.getElementById('form-id').value = '';
  document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('form-item').value = '';
  document.getElementById('form-price').value = '';
  document.getElementById('form-quantity').value = '1';
  document.getElementById('form-currency').value = 'gbp';
  document.getElementById('form-source').value = 'store';
  document.getElementById('form-notes').value = '';
  document.getElementById('form-auto-calc').textContent = '';
  document.getElementById('form-currency-symbol').innerHTML = '&pound;';
  document.getElementById('form-delivery-fee').value = '';
  populateStoreDropdown('');
  toggleDeliveryFee();
  openModal();
}

function openEditModal(id) {
  const entry = purchases.find(e => e.id === id);
  if (!entry) return;
  editingId = id;
  document.getElementById('modal-title').textContent = 'Edit Purchase';
  document.getElementById('form-submit-btn').textContent = 'Save Changes';
  document.getElementById('form-id').value = entry.id;
  document.getElementById('form-date').value = entry.date;
  document.getElementById('form-item').value = entry.item;
  document.getElementById('form-currency').value = 'gbp';
  document.getElementById('form-price').value = entry.price_gbp.toFixed(2);
  document.getElementById('form-quantity').value = entry.quantity || 1;
  document.getElementById('form-source').value = entry.source;
  document.getElementById('form-notes').value = entry.notes || '';
  document.getElementById('form-currency-symbol').innerHTML = '&pound;';
  document.getElementById('form-delivery-fee').value = entry.delivery_fee_gbp ? entry.delivery_fee_gbp.toFixed(2) : '';
  populateStoreDropdown(entry.store_name || '');
  toggleDeliveryFee();
  recalcPrice();
  openModal();
}

function openModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('form-date').focus(), 300);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('card-confirm-overlay').classList.contains('open')) {
      closeCardConfirm();
    } else if (document.getElementById('card-modal-overlay').classList.contains('open')) {
      closeCardModal();
    } else if (document.getElementById('confirm-overlay').classList.contains('open')) {
      closeConfirm();
    } else if (document.getElementById('modal-overlay').classList.contains('open')) {
      closeModal();
    }
  }
});

function recalcPrice() {
  const cur = document.getElementById('form-currency').value;
  const priceVal = parseFloat(document.getElementById('form-price').value);
  const qty = parseInt(document.getElementById('form-quantity').value) || 1;
  const symbols = { gbp: '&pound;', eur: '&euro;', usd: '$' };
  document.getElementById('form-currency-symbol').innerHTML = symbols[cur];
  document.getElementById('form-delivery-symbol').innerHTML = symbols[cur];

  if (isNaN(priceVal) || priceVal <= 0) {
    document.getElementById('form-auto-calc').textContent = '';
    return;
  }

  // Convert input to GBP first
  let gbp;
  if (cur === 'gbp') gbp = priceVal;
  else if (cur === 'eur') gbp = priceVal / rates.eur;
  else gbp = priceVal / rates.usd;

  const eur = gbp * rates.eur;
  const usd = gbp * rates.usd;
  const lineTotal = priceVal * qty;

  let parts = [];
  if (cur !== 'gbp') parts.push('\u00A3' + gbp.toFixed(2));
  if (cur !== 'eur') parts.push('\u20AC' + eur.toFixed(2));
  if (cur !== 'usd') parts.push('$' + usd.toFixed(2));

  let text = '= ' + parts.join(' / ');
  if (qty > 1) text += ` | Line total: ${symbols[cur].replace(/&[a-z]+;/g, match => ({'&pound;':'\u00A3','&euro;':'\u20AC'}[match]||match))}${lineTotal.toFixed(2)}`;
  if (qty > 1) {
    const sym = cur === 'gbp' ? '\u00A3' : cur === 'eur' ? '\u20AC' : '$';
    text = '= ' + parts.join(' / ') + ' | Line total: ' + sym + lineTotal.toFixed(2);
  }
  document.getElementById('form-auto-calc').textContent = text;
}

function toggleDeliveryFee() {
  const source = document.getElementById('form-source').value;
  const group = document.getElementById('delivery-fee-group');
  group.style.display = (source === 'online') ? 'block' : 'none';
  if (source !== 'online') document.getElementById('form-delivery-fee').value = '';
  recalcPrice();
}

/* ===== Save ===== */
function savePurchase(e) {
  e.preventDefault();
  const cur = document.getElementById('form-currency').value;
  const price = parseFloat(document.getElementById('form-price').value);
  const qty = parseInt(document.getElementById('form-quantity').value) || 1;
  if (isNaN(price) || price < 0) return;

  // Convert to GBP as base
  let gbp;
  if (cur === 'gbp') gbp = price;
  else if (cur === 'eur') gbp = price / rates.eur;
  else gbp = price / rates.usd;

  // Delivery fee (online only)
  const source = document.getElementById('form-source').value;
  let deliveryFeeGbp = 0;
  if (source === 'online') {
    const delVal = parseFloat(document.getElementById('form-delivery-fee').value);
    if (!isNaN(delVal) && delVal > 0) {
      if (cur === 'gbp') deliveryFeeGbp = delVal;
      else if (cur === 'eur') deliveryFeeGbp = delVal / rates.eur;
      else deliveryFeeGbp = delVal / rates.usd;
    }
  }

  const entry = {
    id: editingId || crypto.randomUUID(),
    date: document.getElementById('form-date').value,
    item: document.getElementById('form-item').value.trim(),
    quantity: qty,
    price_gbp: parseFloat(gbp.toFixed(2)),
    price_eur: parseFloat((gbp * rates.eur).toFixed(2)),
    price_usd: parseFloat((gbp * rates.usd).toFixed(2)),
    source: source,
    store_name: document.getElementById('form-store-name').value || '',
    notes: document.getElementById('form-notes').value.trim(),
    delivery_fee_gbp: parseFloat(deliveryFeeGbp.toFixed(2)),
  };

  if (editingId) {
    const idx = purchases.findIndex(e => e.id === editingId);
    if (idx !== -1) purchases[idx] = entry;
    showToast('Purchase updated');
  } else {
    purchases.push(entry);
    showToast('Purchase added');
  }

  saveToStorage();
  syncStoreNamesFromPurchases();
  closeModal();
  currentPage = 1;
  renderAll();
}

/* ===== Delete ===== */
let deleteTargetId = null;

function confirmDelete(id) {
  deleteTargetId = id;
  const entry = purchases.find(e => e.id === id);
  document.getElementById('confirm-desc').textContent = entry
    ? `Delete "${entry.item}"? This action cannot be undone.`
    : 'This action cannot be undone.';
  document.getElementById('confirm-overlay').classList.add('open');
  document.getElementById('confirm-delete-btn').focus();
}

function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('open');
  deleteTargetId = null;
}

document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  if (deleteTargetId) {
    purchases = purchases.filter(e => e.id !== deleteTargetId);
    saveToStorage();
    showToast('Purchase deleted');
    closeConfirm();
    renderAll();
  }
});

document.getElementById('confirm-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

/* ===== Export / Import ===== */
function exportJSON() {
  const blob = new Blob([JSON.stringify(purchases, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('JSON exported');
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('Invalid format');
      // Migrate imported data
      data.forEach(p => {
        if (!p.quantity) p.quantity = 1;
        if (p.price_usd === undefined) p.price_usd = parseFloat((p.price_gbp * rates.usd).toFixed(2));
        if (p.delivery_fee_gbp === undefined) p.delivery_fee_gbp = 0;
      });
      purchases = data;
      saveToStorage();
      syncStoreNamesFromPurchases();
      currentPage = 1;
      renderAll();
      showToast('Imported ' + data.length + ' purchase' + (data.length !== 1 ? 's' : ''));
    } catch (err) {
      showToast('Error: Invalid JSON file');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

/* ===== Toast ===== */
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => toast.classList.remove('show'), 2500);
}

/* ============================================================
   CARD TRACKER MODULE
   ============================================================ */

/* ===== Card Tracker State ===== */
let cardEntries = [];
let cardSeriesList = [];
let ctPage = 1;
const CT_PAGE_SIZE = 20;
let ctEditingId = null;
let ctDeleteTargetId = null;
let ctSortCol = 'date'; // card table sort column
let ctSortDir = 'desc'; // card table sort direction
let prSortCol = 'series'; // pull rates sort column
let prSortDir = 'asc'; // pull rates sort direction

/* ===== Card Tracker Init ===== */
async function initCardTracker() {
  await loadCardEntries();
  loadCardSeries();
  renderCardAll();

  // Card modal overlay click-to-close
  document.getElementById('card-modal-overlay').addEventListener('click', function(e) {
    if (e.target === this) closeCardModal();
  });

  // Card confirm overlay click-to-close
  document.getElementById('card-confirm-overlay').addEventListener('click', function(e) {
    if (e.target === this) closeCardConfirm();
  });

  // Card confirm delete button
  document.getElementById('card-confirm-delete-btn').addEventListener('click', function() {
    if (ctDeleteTargetId) {
      cardEntries = cardEntries.filter(c => c.id !== ctDeleteTargetId);
      saveCardEntries();
      showToast('Card entry deleted');
      closeCardConfirm();
      renderCardAll();
    }
  });
}

async function loadCardEntries() {
  const existingIds = new Set();
  try {
    const saved = localStorage.getItem('poketracker_cards');
    if (saved) {
      cardEntries = JSON.parse(saved);
      if (Array.isArray(cardEntries) && cardEntries.length > 0) {
        let changed = false;
        cardEntries.forEach(c => {
          existingIds.add(c.id);
          if (c.series === 'Scarlet & Violet') {
            c.series = 'Scarlet & violet - Journey Together';
            changed = true;
          }
        });
        if (changed) saveCardEntries();
        // Merge any new entries from seed file (e.g. Melodelfe, Zoroark)
        try {
          const res = await fetch('./card_data.json');
          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data)) {
              let merged = false;
              data.forEach(entry => {
                if (entry && entry.id && !existingIds.has(entry.id)) {
                  cardEntries.push(entry);
                  existingIds.add(entry.id);
                  merged = true;
                }
              });
              if (merged) saveCardEntries();
            }
          }
        } catch(e) { /* ignore */ }
        return;
      }
    }
  } catch(e) { /* fall through */ }
  // Fall back to card_data.json seed file
  try {
    const res = await fetch('./card_data.json');
    if (!res.ok) throw new Error('No seed file');
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      cardEntries = data;
      saveCardEntries();
      return;
    }
  } catch(e) {
    console.warn('Could not load card_data.json:', e);
  }
  cardEntries = [];
}

function saveCardEntries() {
  try {
    localStorage.setItem('poketracker_cards', JSON.stringify(cardEntries));
  } catch(e) { console.warn('Could not save card entries:', e); }
}

function loadCardSeries() {
  const seriesSet = new Set();
  cardEntries.forEach(c => { if (c.series) seriesSet.add(c.series); });
  cardSeriesList = [...seriesSet].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
}

/* ===== Main Tab Switching ===== */
function switchMainTab(tab) {
  document.querySelectorAll('.main-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.tab === tab);
    t.setAttribute('aria-selected', t.dataset.tab === tab);
  });
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  updateHeaderAddButton(tab);
  if (tab === 'cards') {
    renderCardAll();
  }
}

function headerAddAction() {
  const activeTab = document.querySelector('.main-tab.active');
  if (activeTab && activeTab.dataset.tab === 'cards') {
    openCardModal();
  } else {
    openAddModal();
  }
}

function updateHeaderAddButton(tab) {
  const btn = document.getElementById('header-add-btn');
  const label = document.getElementById('header-add-label');
  if (!btn || !label) return;
  if (tab === 'cards') {
    label.textContent = 'Add Card Entry';
    btn.setAttribute('aria-label', 'Add card entry');
  } else {
    label.textContent = 'Add Purchase';
    btn.setAttribute('aria-label', 'Add purchase');
  }
}

/* ===== Card Sub-tab Switching ===== */
function switchCardSubTab(tab, el) {
  document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
  document.getElementById('sub-' + tab).classList.add('active');
}

/* ===== Card Tracker Render All ===== */
function renderCardAll() {
  loadCardSeries();
  renderCardDashboard();
  updateCardDataLists();
  renderCardTable();
  renderPullRates();
}

/* ===== Card Dashboard ===== */
function renderCardDashboard() {
  const totalPacks = cardEntries.length;
  const seriesCount = new Set(cardEntries.map(c => c.series)).size;
  const rareCount = cardEntries.filter(c => c.had_rare).length;
  const pullRate = totalPacks > 0 ? ((rareCount / totalPacks) * 100).toFixed(1) : '0.0';
  const avgWeight = totalPacks > 0 ? (cardEntries.reduce((s, c) => s + (c.weight || 0), 0) / totalPacks).toFixed(3) : '0.000';

  document.getElementById('ct-total-packs').textContent = totalPacks;
  document.getElementById('ct-total-packs-sub').textContent = totalPacks === 1 ? '1 pack opened' : totalPacks + ' packs opened';
  document.getElementById('ct-series-count').textContent = seriesCount;
  document.getElementById('ct-series-count-sub').textContent = seriesCount === 1 ? '1 unique series' : seriesCount + ' unique series';
  document.getElementById('ct-pull-rate').textContent = pullRate + '%';
  document.getElementById('ct-pull-rate-sub').textContent = rareCount + ' rare' + (rareCount !== 1 ? 's' : '') + ' found';
  document.getElementById('ct-avg-weight').textContent = avgWeight + 'g';
  document.getElementById('ct-avg-weight-sub').textContent = 'per pack average';
}

/* ===== Update Datalists ===== */
function updateCardDataLists() {
  // Series datalist
  const seriesDl = document.getElementById('series-datalist');
  seriesDl.innerHTML = cardSeriesList.map(s => '<option value="' + escapeHtml(s) + '">').join('');

  // Cover picture datalist
  const covers = [...new Set(cardEntries.map(c => c.cover_picture).filter(Boolean))].sort(
    (a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' })
  );
  const coverDl = document.getElementById('cover-datalist');
  coverDl.innerHTML = covers.map(c => '<option value="' + escapeHtml(c) + '">').join('');

  // Series filter dropdown
  const sel = document.getElementById('ct-series-filter');
  const currentVal = sel.value;
  sel.innerHTML = '<option value="all">All Series</option>';
  cardSeriesList.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    sel.appendChild(opt);
  });
  sel.value = currentVal || 'all';
}

/* ===== Card Table ===== */
function ctSortFromMobile(selectEl) {
  const v = (selectEl && selectEl.value) || 'date-desc';
  const [col, dir] = v.split('-');
  ctSortCol = col;
  ctSortDir = dir || 'desc';
  updateSortHeaders('ct-table', ctSortCol, ctSortDir);
  ctPage = 1;
  renderCardTable();
}

function sortCards(col, thEl) {
  if (ctSortCol === col) { ctSortDir = ctSortDir === 'asc' ? 'desc' : 'asc'; }
  else { ctSortCol = col; ctSortDir = (col === 'date') ? 'desc' : 'asc'; }
  updateSortHeaders('ct-table', ctSortCol, ctSortDir);
  const sel = document.getElementById('ct-sort-select');
  if (sel) sel.value = ctSortCol + '-' + ctSortDir;
  ctPage = 1;
  renderCardTable();
}

function getFilteredCards() {
  let list = [...cardEntries];
  const seriesFilter = document.getElementById('ct-series-filter').value;
  const search = (document.getElementById('ct-search').value || '').toLowerCase().trim();

  if (seriesFilter !== 'all') list = list.filter(c => c.series === seriesFilter);
  if (search) list = list.filter(c =>
    (c.cover_picture || '').toLowerCase().includes(search) ||
    (c.series || '').toLowerCase().includes(search)
  );

  const dir = ctSortDir === 'asc' ? 1 : -1;
  list.sort((a, b) => {
    let va, vb;
    switch (ctSortCol) {
      case 'date': va = new Date(a.created_at).getTime(); vb = new Date(b.created_at).getTime(); break;
      case 'series': va = (a.series || '').toLowerCase(); vb = (b.series || '').toLowerCase(); break;
      case 'weight': va = a.weight || 0; vb = b.weight || 0; break;
      case 'cover': va = (a.cover_picture || '').toLowerCase(); vb = (b.cover_picture || '').toLowerCase(); break;
      case 'bipped': va = a.bipped ? 1 : 0; vb = b.bipped ? 1 : 0; break;
      case 'rare': va = a.had_rare ? 1 : 0; vb = b.had_rare ? 1 : 0; break;
      default: va = new Date(a.created_at).getTime(); vb = new Date(b.created_at).getTime();
    }
    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });
  return list;
}

function renderCardTable() {
  const filtered = getFilteredCards();
  const tbody = document.getElementById('ct-table-body');
  const tableEl = document.getElementById('ct-table');
  const emptyEl = document.getElementById('ct-empty');
  const noResults = document.getElementById('ct-no-results');
  const pagEl = document.getElementById('ct-pagination');

  if (cardEntries.length === 0) {
    tableEl.style.display = 'none';
    pagEl.style.display = 'none';
    noResults.style.display = 'none';
    emptyEl.style.display = 'block';
    return;
  }
  emptyEl.style.display = 'none';

  if (filtered.length === 0) {
    tableEl.style.display = 'none';
    pagEl.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }
  noResults.style.display = 'none';
  tableEl.style.display = 'table';

  const sortSel = document.getElementById('ct-sort-select');
  if (sortSel) sortSel.value = ctSortCol + '-' + ctSortDir;

  const totalPages = Math.ceil(filtered.length / CT_PAGE_SIZE);
  if (ctPage > totalPages) ctPage = totalPages;
  if (ctPage < 1) ctPage = 1;
  const start = (ctPage - 1) * CT_PAGE_SIZE;
  const pageItems = filtered.slice(start, start + CT_PAGE_SIZE);

  var mobile = isMobileTable();
  var cardActionsHtml = function(entry) {
    return '<div class="actions-cell">' +
      '<button type="button" class="btn-icon" onclick="openEditCardModal(\'' + entry.id + '\')" aria-label="Edit entry">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
      '</button>' +
      '<button type="button" class="btn-icon delete" onclick="confirmCardDelete(\'' + entry.id + '\')" aria-label="Delete entry">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>' +
      '</button></div>';
  };
  tbody.innerHTML = pageItems.map(entry => {
    var dateFormatted = new Date(entry.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    var firstTd = mobile
      ? '<td data-label="Date" class="date-with-actions">' + dateFormatted + cardActionsHtml(entry) + '</td>'
      : '<td data-label="Date">' + dateFormatted + '</td>';
    var lastTd = mobile
      ? '<td data-label="" class="actions-col-placeholder"></td>'
      : '<td data-label="">' + cardActionsHtml(entry) + '</td>';
    return '<tr>' +
      firstTd +
      '<td data-label="Series"><strong>' + escapeHtml(entry.series) + '</strong></td>' +
      '<td data-label="Weight" class="weight-cell">' + entry.weight.toFixed(3) + 'g</td>' +
      '<td data-label="Cover">' + (entry.cover_picture ? escapeHtml(entry.cover_picture) : '<span style="color:var(--text-muted)">-</span>') + '</td>' +
      '<td data-label="Bipped">' + (entry.bipped ? '<span class="badge badge-bipped">Bipped</span>' : '<span class="badge badge-no">No</span>') + '</td>' +
      '<td data-label="Rare">' + (entry.had_rare ? '<span class="badge badge-yes">Rare</span>' : '<span class="badge badge-no">No</span>') + '</td>' +
      lastTd +
    '</tr>';
  }).join('');

  // Pagination
  if (totalPages <= 1) {
    pagEl.style.display = 'none';
  } else {
    pagEl.style.display = 'flex';
    let html = '<button type="button" ' + (ctPage === 1 ? 'disabled' : '') + ' onclick="ctGoToPage(' + (ctPage - 1) + ')">&laquo;</button>';
    for (let i = 1; i <= totalPages; i++) {
      if (totalPages > 7 && i > 2 && i < totalPages - 1 && Math.abs(i - ctPage) > 1) {
        if (i === 3 || i === totalPages - 2) html += '<button type="button" disabled>...</button>';
        continue;
      }
      html += '<button type="button" class="' + (i === ctPage ? 'active' : '') + '" onclick="ctGoToPage(' + i + ')">' + i + '</button>';
    }
    html += '<button type="button" ' + (ctPage === totalPages ? 'disabled' : '') + ' onclick="ctGoToPage(' + (ctPage + 1) + ')">&raquo;</button>';
    pagEl.innerHTML = html;
  }
}

function ctGoToPage(page) {
  ctPage = page;
  renderCardTable();
  document.querySelector('#tab-cards .table-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ===== Pull Rates ===== */
function sortPullRates(col, thEl) {
  if (prSortCol === col) { prSortDir = prSortDir === 'asc' ? 'desc' : 'asc'; }
  else { prSortCol = col; prSortDir = (col === 'series') ? 'asc' : 'desc'; }
  updateSortHeaders('ct-pull-table', prSortCol, prSortDir);
  renderPullRates();
}

function renderPullRates() {
  const seriesMap = {};
  cardEntries.forEach(c => {
    if (!seriesMap[c.series]) {
      seriesMap[c.series] = { total: 0, rares: 0, totalWeight: 0 };
    }
    seriesMap[c.series].total++;
    if (c.had_rare) seriesMap[c.series].rares++;
    seriesMap[c.series].totalWeight += (c.weight || 0);
  });

  // Build sortable array
  const seriesRows = Object.keys(seriesMap).map(s => {
    const d = seriesMap[s];
    return { name: s, total: d.total, rares: d.rares, avgW: d.totalWeight / d.total, rate: (d.rares / d.total) * 100 };
  });

  const dir = prSortDir === 'asc' ? 1 : -1;
  seriesRows.sort((a, b) => {
    let va, vb;
    switch (prSortCol) {
      case 'series': va = a.name.toLowerCase(); vb = b.name.toLowerCase(); break;
      case 'total': va = a.total; vb = b.total; break;
      case 'rares': va = a.rares; vb = b.rares; break;
      case 'weight': va = a.avgW; vb = b.avgW; break;
      case 'rate': va = a.rate; vb = b.rate; break;
      default: va = a.name.toLowerCase(); vb = b.name.toLowerCase();
    }
    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });

  const tbody = document.getElementById('ct-pull-body');
  const emptyEl = document.getElementById('ct-pull-empty');
  const tableEl = document.getElementById('ct-pull-table');

  if (seriesRows.length === 0) {
    tableEl.style.display = 'none';
    emptyEl.style.display = 'block';
    document.getElementById('ct-pull-summary').innerHTML = '';
    return;
  }
  emptyEl.style.display = 'none';
  tableEl.style.display = 'table';

  tbody.innerHTML = seriesRows.map(r => {
    return '<tr>' +
      '<td data-label="Series"><strong>' + escapeHtml(r.name) + '</strong></td>' +
      '<td data-label="Packs">' + r.total + '</td>' +
      '<td data-label="Rares">' + r.rares + '</td>' +
      '<td data-label="Avg Wt" class="weight-cell">' + r.avgW.toFixed(3) + 'g</td>' +
      '<td data-label="Rate"><span class="badge ' + (r.rate > 0 ? 'badge-yes' : 'badge-no') + '">' + r.rate.toFixed(2) + '%</span></td>' +
    '</tr>';
  }).join('');

  // Summary cards
  const totalPacks = cardEntries.length;
  const totalRares = cardEntries.filter(c => c.had_rare).length;
  const overallRate = totalPacks > 0 ? ((totalRares / totalPacks) * 100).toFixed(2) : '0.00';

  document.getElementById('ct-pull-summary').innerHTML =
    '<div class="card"><div class="card-label">Total Series</div><div class="card-value">' + seriesRows.length + '</div></div>' +
    '<div class="card"><div class="card-label">Total Packs</div><div class="card-value">' + totalPacks + '</div></div>' +
    '<div class="card"><div class="card-label">Overall Pull Rate</div><div class="card-value">' + overallRate + '%</div></div>';
}

/* ===== Card Modal ===== */
function openCardModal() {
  ctEditingId = null;
  document.getElementById('card-modal-title').textContent = 'Add Card Entry';
  document.getElementById('card-form-submit').textContent = 'Add Entry';
  document.getElementById('card-form-id').value = '';
  document.getElementById('card-form-series').value = '';
  document.getElementById('card-form-weight').value = '';
  document.getElementById('card-form-cover').value = '';
  document.getElementById('card-form-bipped').checked = false;
  document.getElementById('card-form-rare').checked = false;
  updateCardDataLists();
  document.getElementById('card-modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(function() { document.getElementById('card-form-series').focus(); }, 300);
}

function openEditCardModal(id) {
  const entry = cardEntries.find(function(c) { return c.id === id; });
  if (!entry) return;
  ctEditingId = id;
  document.getElementById('card-modal-title').textContent = 'Edit Card Entry';
  document.getElementById('card-form-submit').textContent = 'Save Changes';
  document.getElementById('card-form-id').value = entry.id;
  document.getElementById('card-form-series').value = entry.series;
  document.getElementById('card-form-weight').value = entry.weight;
  document.getElementById('card-form-cover').value = entry.cover_picture || '';
  document.getElementById('card-form-bipped').checked = entry.bipped;
  document.getElementById('card-form-rare').checked = entry.had_rare;
  updateCardDataLists();
  document.getElementById('card-modal-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeCardModal() {
  document.getElementById('card-modal-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

/* ===== Save Card Entry ===== */
function saveCardEntry(e) {
  e.preventDefault();
  const series = document.getElementById('card-form-series').value.trim();
  const weight = parseFloat(document.getElementById('card-form-weight').value);
  const cover = document.getElementById('card-form-cover').value.trim();
  const bipped = document.getElementById('card-form-bipped').checked;
  const rare = document.getElementById('card-form-rare').checked;

  if (!series || isNaN(weight) || weight <= 0) {
    showToast('Please enter a series and valid weight');
    return;
  }

  const existingEntry = ctEditingId ? cardEntries.find(function(c) { return c.id === ctEditingId; }) : null;

  const entry = {
    id: ctEditingId || crypto.randomUUID(),
    series: series,
    weight: parseFloat(weight.toFixed(3)),
    cover_picture: cover || null,
    bipped: bipped,
    had_rare: rare,
    created_at: existingEntry ? existingEntry.created_at : new Date().toISOString()
  };

  if (ctEditingId) {
    const idx = cardEntries.findIndex(function(c) { return c.id === ctEditingId; });
    if (idx !== -1) cardEntries[idx] = entry;
    showToast('Card entry updated');
  } else {
    cardEntries.push(entry);
    showToast('Card entry added');
  }

  saveCardEntries();
  closeCardModal();
  ctPage = 1;
  renderCardAll();
}

/* ===== Delete Card ===== */
function confirmCardDelete(id) {
  ctDeleteTargetId = id;
  const entry = cardEntries.find(function(c) { return c.id === id; });
  document.getElementById('card-confirm-desc').textContent = entry
    ? 'Delete entry for "' + entry.series + '" (' + entry.weight + 'g)? This cannot be undone.'
    : 'This action cannot be undone.';
  document.getElementById('card-confirm-overlay').classList.add('open');
  document.getElementById('card-confirm-delete-btn').focus();
}

function closeCardConfirm() {
  document.getElementById('card-confirm-overlay').classList.remove('open');
  ctDeleteTargetId = null;
}

/* ===== Card Export/Import ===== */
function exportCardJSON() {
  const blob = new Blob([JSON.stringify(cardEntries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'card_entries.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Card entries exported');
}

function importCardJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('Invalid format');
      // Basic validation
      data.forEach(function(c) {
        if (!c.id) c.id = crypto.randomUUID();
        if (!c.created_at) c.created_at = new Date().toISOString();
        if (c.bipped === undefined) c.bipped = false;
        if (c.had_rare === undefined) c.had_rare = false;
      });
      cardEntries = data;
      saveCardEntries();
      ctPage = 1;
      renderCardAll();
      showToast('Imported ' + data.length + ' card entr' + (data.length !== 1 ? 'ies' : 'y'));
    } catch(err) {
      showToast('Error: Invalid JSON file');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}
</script>
</body>
</html>
